# 커뮤니티 변경사항(Changelog) 시스템

## 개요

프로젝트 커뮤니티에서 프로젝트의 릴리즈 노트와 변경사항을 관리하는 시스템입니다. 프로젝트 생성자만 변경사항을 생성/수정/삭제할 수 있으며, 일반 사용자는 조회만 가능합니다.

### 주요 기능

- **변경사항 작성/수정/삭제**: 프로젝트의 릴리즈 노트 관리
- **버전 관리**: 버전 번호를 통한 릴리즈 구분
- **변경사항 분류**: 새 기능(feature), 개선(improvement), 수정(fix), 주의(breaking) 분류
- **링크 추가**: 저장소 URL 및 다운로드 URL 추가
- **정렬**: 릴리즈 날짜 최신순 정렬
- **페이지네이션**: 대량의 변경사항을 효율적으로 조회

---

## 데이터베이스 스키마

### 변경사항 테이블 (`odd.tbl_changelogs`)

프로젝트의 변경사항을 저장하는 테이블입니다. `odd.projects`와 N:1 관계입니다.

#### 스키마

```sql
CREATE TABLE odd.tbl_changelogs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id uuid NOT NULL REFERENCES odd.projects(id) ON DELETE CASCADE,
    
    -- 변경사항 정보
    version text NOT NULL,  -- 버전 (최대 20자)
    title text NOT NULL,  -- 제목 (최대 50자)
    description text,  -- 설명 (최대 200자)
    changes jsonb NOT NULL DEFAULT '[]'::jsonb,  -- 변경사항 배열 [{id, type, description}]
    released_at date NOT NULL,  -- 릴리즈 날짜
    
    -- 링크 정보
    repository_url text,  -- 저장소 URL
    download_url text,  -- 다운로드 URL
    
    -- 타임스탬프
    created_at timestamptz DEFAULT now() NOT NULL,
    updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### 주요 컬럼 설명

| 컬럼 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `id` | uuid | ✅ | 고유 ID (자동 생성) |
| `project_id` | uuid | ✅ | 프로젝트 ID (`odd.projects.id` 참조) |
| `version` | text | ✅ | 버전 (최대 20자, 예: v1.0.0) |
| `title` | text | ✅ | 제목 (최대 50자) |
| `description` | text | - | 설명 (최대 200자) |
| `changes` | jsonb | ✅ | 변경사항 배열: `[{id, type, description}]` (기본값: 빈 배열) |
| `released_at` | date | ✅ | 릴리즈 날짜 |
| `repository_url` | text | - | 저장소 URL (선택) |
| `download_url` | text | - | 다운로드 URL (선택) |
| `created_at` | timestamptz | ✅ | 생성일시 |
| `updated_at` | timestamptz | ✅ | 수정일시 (트리거로 자동 업데이트) |

#### 변경사항 타입 (`changes` JSONB 구조)

```typescript
interface ChangelogChange {
  id: string;
  type: "feature" | "improvement" | "fix" | "breaking";
  description: string;
}
```

- **feature**: 새 기능 추가
- **improvement**: 기존 기능 개선
- **fix**: 버그 수정
- **breaking**: 호환성을 깨는 변경사항

#### 인덱스

| 인덱스명 | 컬럼 | 용도 |
|---------|------|------|
| `idx_tbl_changelogs_project_id` | `project_id` | 프로젝트별 변경사항 조회 |
| `idx_tbl_changelogs_released_at` | `released_at DESC` | 릴리즈 날짜 최신순 정렬 |
| `idx_tbl_changelogs_created_at` | `created_at DESC` | 생성일시 최신순 정렬 |

---

## API 함수 명세

### 1. 변경사항 목록 조회 (`v1_fetch_changelogs`)

프로젝트의 변경사항 목록을 조회합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_fetch_changelogs(
    p_project_id uuid,
    p_limit integer DEFAULT 50,
    p_offset integer DEFAULT 0
)
RETURNS TABLE (
    id uuid,
    project_id uuid,
    version text,
    title text,
    description text,
    changes jsonb,
    released_at date,
    repository_url text,
    download_url text,
    created_at timestamptz,
    updated_at timestamptz
)
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_project_id` | uuid | ✅ | 프로젝트 ID |
| `p_limit` | integer | - | 조회 개수 제한 (기본값: 50, 최대: 100) |
| `p_offset` | integer | - | 페이지네이션 오프셋 (기본값: 0) |

#### 반환값

- 변경사항 목록 (정렬: 릴리즈 날짜 최신순 → 생성일시 최신순)

#### 권한

- `authenticated`: 인증된 사용자
- `anon`: 익명 사용자 (읽기 전용)

#### 사용 예시

```typescript
import { fetchChangelogs } from "@/entities/project/api/project.api";

const { changelogs, error } = await fetchChangelogs(projectId, {
  limit: 50,
  offset: 0,
});
```

---

### 2. 변경사항 생성 (`v1_create_changelog`)

변경사항을 생성합니다. 프로젝트 생성자만 생성 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_create_changelog(
    p_project_id uuid,
    p_version text,
    p_title text,
    p_description text DEFAULT NULL,
    p_changes jsonb DEFAULT '[]'::jsonb,
    p_released_at date DEFAULT NULL,
    p_repository_url text DEFAULT NULL,
    p_download_url text DEFAULT NULL
)
RETURNS uuid
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_project_id` | uuid | ✅ | 프로젝트 ID |
| `p_version` | text | ✅ | 버전 (최대 20자) |
| `p_title` | text | ✅ | 제목 (최대 50자) |
| `p_description` | text | - | 설명 (최대 200자) |
| `p_changes` | jsonb | - | 변경사항 배열 (기본값: 빈 배열) |
| `p_released_at` | date | - | 릴리즈 날짜 (NULL이면 오늘 날짜) |
| `p_repository_url` | text | - | 저장소 URL |
| `p_download_url` | text | - | 다운로드 URL |

#### 반환값

- 생성된 변경사항 ID (UUID)

#### 권한

- `authenticated`: 인증된 사용자 (프로젝트 생성자만 가능)

#### 보안

- 프로젝트 `author_id`와 현재 사용자 비교하여 권한 체크
- 권한이 없으면 예외 발생

#### 사용 예시

```typescript
import { createChangelog } from "@/entities/project/api/project.api";

const { changelogId, error } = await createChangelog(projectId, {
  version: "v1.0.0",
  title: "첫 번째 릴리즈",
  description: "프로젝트의 첫 번째 정식 릴리즈입니다.",
  changes: [
    { id: "ch1", type: "feature", description: "사용자 인증 기능 추가" },
    { id: "ch2", type: "improvement", description: "UI 개선" },
  ],
  releasedAt: "2024-12-01",
  repositoryUrl: "https://github.com/example/project/releases/tag/v1.0.0",
});
```

---

### 3. 변경사항 수정 (`v1_update_changelog`)

변경사항을 수정합니다. 프로젝트 생성자만 수정 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_update_changelog(
    p_changelog_id uuid,
    p_version text DEFAULT NULL,
    p_title text DEFAULT NULL,
    p_description text DEFAULT NULL,
    p_changes jsonb DEFAULT NULL,
    p_released_at date DEFAULT NULL,
    p_repository_url text DEFAULT NULL,
    p_download_url text DEFAULT NULL
)
RETURNS boolean
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_changelog_id` | uuid | ✅ | 변경사항 ID |
| `p_version` | text | - | 버전 (NULL이면 변경하지 않음) |
| `p_title` | text | - | 제목 (NULL이면 변경하지 않음) |
| `p_description` | text | - | 설명 (NULL이면 변경하지 않음) |
| `p_changes` | jsonb | - | 변경사항 배열 (NULL이면 변경하지 않음) |
| `p_released_at` | date | - | 릴리즈 날짜 (NULL이면 변경하지 않음) |
| `p_repository_url` | text | - | 저장소 URL (NULL이면 변경하지 않음) |
| `p_download_url` | text | - | 다운로드 URL (NULL이면 변경하지 않음) |

#### 반환값

- 성공 여부 (boolean)

#### 권한

- `authenticated`: 인증된 사용자 (프로젝트 생성자만 가능)

#### 보안

- 변경사항의 프로젝트 `author_id`와 현재 사용자 비교하여 권한 체크
- 권한이 없으면 예외 발생

#### 사용 예시

```typescript
import { updateChangelog } from "@/entities/project/api/project.api";

const { success, error } = await updateChangelog(changelogId, {
  title: "수정된 제목",
  changes: [
    { id: "ch1", type: "feature", description: "업데이트된 기능" },
  ],
});
```

---

### 4. 변경사항 삭제 (`v1_delete_changelog`)

변경사항을 삭제합니다. 프로젝트 생성자만 삭제 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_delete_changelog(
    p_changelog_id uuid
)
RETURNS boolean
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_changelog_id` | uuid | ✅ | 변경사항 ID |

#### 반환값

- 성공 여부 (boolean)

#### 권한

- `authenticated`: 인증된 사용자 (프로젝트 생성자만 가능)

#### 보안

- 변경사항의 프로젝트 `author_id`와 현재 사용자 비교하여 권한 체크
- 권한이 없으면 예외 발생

#### 사용 예시

```typescript
import { deleteChangelog } from "@/entities/project/api/project.api";

const { success, error } = await deleteChangelog(changelogId);
```

---

## 프론트엔드 구현

### 컴포넌트 구조

```
src/pages/project/community/
├── tabs/
│   └── ChangelogTab.tsx          # 변경사항 탭 컴포넌트
├── components/
│   └── ChangelogCard.tsx         # 변경사항 카드 컴포넌트
└── types.ts                      # 타입 정의
```

### 주요 컴포넌트

#### ChangelogTab

변경사항 탭의 메인 컴포넌트입니다.

**Props:**

```typescript
interface ChangelogTabProps {
  projectId: string;
  isOwner?: boolean;  // 프로젝트 소유자 여부
}
```

**주요 기능:**

- 변경사항 목록 조회 및 표시
- 변경사항 추가/수정/삭제 (소유자만)
- 로딩 상태 및 에러 처리
- 모달을 통한 변경사항 작성/수정

#### ChangelogCard

개별 변경사항을 표시하는 카드 컴포넌트입니다.

**Props:**

```typescript
interface ChangelogCardProps {
  entry: ChangelogEntry;
  onEdit?: () => void;    // 수정 핸들러 (선택)
  onDelete?: () => void;  // 삭제 핸들러 (선택)
}
```

**주요 기능:**

- 변경사항 정보 표시 (버전, 제목, 설명, 변경사항 목록)
- 링크 표시 (저장소, 다운로드)
- 변경사항 타입별 색상 구분
- 5개 이상 변경사항일 때 "더 보기" 기능

---

## 권한 정책

### 읽기 권한

- **모든 사용자**: 변경사항 조회 가능 (공개)
- RLS 정책: `Anyone can read changelogs`

### 쓰기 권한

- **프로젝트 생성자만**: 변경사항 생성/수정/삭제 가능
- RLS 정책: `Authenticated users can create/update/delete changelogs` (권한 체크는 함수에서 수행)
- SQL 함수에서 프로젝트 `author_id`와 현재 사용자 비교

---

## 사용 예시

### 변경사항 목록 조회

```typescript
import { fetchChangelogs } from "@/entities/project/api/project.api";

// 프로젝트의 변경사항 목록 조회
const { changelogs, error } = await fetchChangelogs(projectId);

if (error) {
  console.error("변경사항 조회 실패:", error);
  return;
}

console.log("변경사항 목록:", changelogs);
```

### 변경사항 생성

```typescript
import { createChangelog } from "@/entities/project/api/project.api";

// 새 변경사항 생성
const { changelogId, error } = await createChangelog(projectId, {
  version: "v2.0.0",
  title: "v2.0 베타 릴리즈",
  description: "대규모 업데이트! AI 기능과 새로운 UI를 만나보세요.",
  changes: [
    { id: "ch1", type: "feature", description: "AI 기반 자동 추천 시스템 추가" },
    { id: "ch2", type: "feature", description: "다크모드 지원" },
    { id: "ch3", type: "improvement", description: "전체 UI/UX 개선" },
    { id: "ch4", type: "fix", description: "Safari 브라우저 호환성 문제 해결" },
    { id: "ch5", type: "breaking", description: "API v1 지원 종료 예정" },
  ],
  releasedAt: "2024-12-01",
  repositoryUrl: "https://github.com/example/project/releases/tag/v2.0.0-beta",
  downloadUrl: "https://example.com/downloads/v2.0.0-beta",
});

if (error) {
  console.error("변경사항 생성 실패:", error);
  return;
}

console.log("생성된 변경사항 ID:", changelogId);
```

### 변경사항 수정

```typescript
import { updateChangelog } from "@/entities/project/api/project.api";

// 변경사항 수정
const { success, error } = await updateChangelog(changelogId, {
  title: "수정된 제목",
  description: "수정된 설명",
  changes: [
    { id: "ch1", type: "feature", description: "업데이트된 기능" },
  ],
});

if (!success || error) {
  console.error("변경사항 수정 실패:", error);
  return;
}

console.log("변경사항 수정 완료");
```

### 변경사항 삭제

```typescript
import { deleteChangelog } from "@/entities/project/api/project.api";

// 변경사항 삭제
const { success, error } = await deleteChangelog(changelogId);

if (!success || error) {
  console.error("변경사항 삭제 실패:", error);
  return;
}

console.log("변경사항 삭제 완료");
```

---

## UI/UX 특징

### 변경사항 카드

- **버전 배지**: 버전 번호를 배지로 표시
- **릴리즈 날짜**: 릴리즈 날짜 표시
- **링크 표시**: 저장소 및 다운로드 링크를 아이콘과 함께 표시
- **변경사항 타입별 색상**: 
  - 새 기능: 초록색 (emerald)
  - 개선: 파란색 (primary)
  - 수정: 노란색 (amber)
  - 주의: 빨간색 (rose)
- **더 보기 기능**: 변경사항이 5개 이상일 때 접기/펼치기 기능

### 관리 기능

- **프로젝트 소유자만**: "변경사항 추가" 버튼 및 수정/삭제 버튼 표시
- **모달 기반 작성/수정**: 전체 화면 모달을 통한 변경사항 작성/수정
- **타입별 입력**: 새 기능, 개선, 수정, 주의 항목을 각각 입력
- **동적 항목 추가/제거**: 각 타입별로 항목을 추가하거나 제거 가능

---

## 참고 파일

- **SQL 테이블 생성**: `docs/sql/032_create_changelogs_table.sql`
- **SQL 함수**: `docs/sql/033_v1_changelog_functions.sql`
- **API 함수**: `src/entities/project/api/project.api.ts`
- **컴포넌트**: `src/pages/project/community/tabs/ChangelogTab.tsx`
- **카드 컴포넌트**: `src/pages/project/community/components/ChangelogCard.tsx`
- **타입 정의**: `src/pages/project/community/types.ts`

---

## 실행 순서

1. **테이블 생성**: `docs/sql/032_create_changelogs_table.sql` 실행
2. **함수 생성**: `docs/sql/033_v1_changelog_functions.sql` 실행
3. **프론트엔드**: 컴포넌트는 이미 구현되어 있으며, API 연동 완료

---

## 주의사항

- 변경사항의 `changes` 필드는 JSONB 타입으로 저장되며, 배열 형태로 저장됩니다.
- 각 변경사항 항목은 `id`, `type`, `description` 필드를 가집니다.
- 프로젝트 소유자만 변경사항을 생성/수정/삭제할 수 있습니다.
- 읽기는 모든 사용자가 가능합니다 (공개).




