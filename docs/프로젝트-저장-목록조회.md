# 프로젝트 저장(북마크) 시스템

## 개요

사용자가 관심 있는 프로젝트를 저장하여 나중에 쉽게 찾아볼 수 있는 기능입니다. 저장한 프로젝트는 저장한 순서대로 정렬되어 표시됩니다.

## 주요 기능

### 1. 프로젝트 저장/해제

- 프로젝트 상세 페이지에서 "저장" 버튼을 클릭하여 저장/해제
- 저장된 프로젝트는 아이콘이 활성화되어 표시됨
- 저장 상태는 실시간으로 동기화됨

### 2. 저장한 프로젝트 목록 조회

- 사용자가 저장한 모든 프로젝트를 조회
- 저장한 순서대로 정렬 (최신 저장 순)
- 페이지네이션 지원

### 3. 저장 상태 확인

- 특정 프로젝트의 저장 여부 확인
- 인증되지 않은 사용자는 항상 false 반환

## 데이터베이스 스키마

### 테이블: `odd.tbl_project_bookmarks`

```sql
CREATE TABLE odd.tbl_project_bookmarks (
    project_id uuid NOT NULL REFERENCES odd.projects(id) ON DELETE CASCADE,
    user_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now() NOT NULL,
    PRIMARY KEY (project_id, user_id)
);
```

**주요 인덱스:**
- `idx_tbl_project_bookmarks_user_id`: 사용자별 저장한 프로젝트 조회 (저장일시 DESC)
- `idx_tbl_project_bookmarks_project_id`: 프로젝트별 저장한 사용자 조회

**RLS 정책:**
- 사용자는 자신이 저장한 프로젝트만 조회 가능
- 인증된 사용자는 프로젝트를 저장할 수 있음
- 사용자는 자신이 저장한 프로젝트를 삭제할 수 있음

## API 함수

### 1. `toggleProjectBookmark`

프로젝트 저장/해제를 토글합니다.

**위치**: `src/entities/project/api/project.api.ts`

**함수 시그니처:**
```typescript
async function toggleProjectBookmark(
  projectId: string
): Promise<ToggleProjectBookmarkResult>
```

**반환 타입:**
```typescript
interface ToggleProjectBookmarkResult {
  isBookmarked: boolean;  // 현재 저장 상태
  bookmarksCount: number; // 프로젝트의 총 저장 수
  error: Error | null;
}
```

**사용 예시:**
```typescript
import { toggleProjectBookmark } from "@/entities/project";

const { isBookmarked, bookmarksCount, error } = await toggleProjectBookmark(projectId);

if (error) {
  console.error("저장 실패:", error);
  return;
}

console.log(`저장 상태: ${isBookmarked ? "저장됨" : "해제됨"}`);
console.log(`총 저장 수: ${bookmarksCount}`);
```

**동작 방식:**
- 이미 저장되어 있으면 저장 해제
- 저장되어 있지 않으면 저장
- 저장/해제 후 현재 상태와 총 저장 수 반환

---

### 2. `checkProjectBookmark`

프로젝트 저장 상태를 확인합니다.

**위치**: `src/entities/project/api/project.api.ts`

**함수 시그니처:**
```typescript
async function checkProjectBookmark(
  projectId: string
): Promise<CheckProjectBookmarkResult>
```

**반환 타입:**
```typescript
interface CheckProjectBookmarkResult {
  isBookmarked: boolean;  // 저장 여부
  error: Error | null;
}
```

**사용 예시:**
```typescript
import { checkProjectBookmark } from "@/entities/project";

const { isBookmarked, error } = await checkProjectBookmark(projectId);

if (error) {
  console.error("저장 상태 확인 실패:", error);
  return;
}

if (isBookmarked) {
  console.log("이 프로젝트는 저장되어 있습니다");
}
```

**동작 방식:**
- 인증되지 않은 사용자는 항상 `false` 반환
- 인증된 사용자는 실제 저장 상태 반환

---

### 3. `fetchSavedProjects`

저장한 프로젝트 목록을 조회합니다.

**위치**: `src/entities/project/api/project.api.ts`

**함수 시그니처:**
```typescript
async function fetchSavedProjects(
  options?: FetchSavedProjectsOptions
): Promise<FetchSavedProjectsResult>
```

**옵션 타입:**
```typescript
interface FetchSavedProjectsOptions {
  limit?: number;   // 조회 개수 제한 (기본값: 50, 최대: 100)
  offset?: number; // 페이지네이션 오프셋 (기본값: 0)
}
```

**반환 타입:**
```typescript
interface FetchSavedProjectsResult {
  projects: Project[];  // 저장한 프로젝트 목록
  error: Error | null;
}
```

**사용 예시:**
```typescript
import { fetchSavedProjects } from "@/entities/project";

// 첫 페이지 조회
const { projects, error } = await fetchSavedProjects({
  limit: 20,
  offset: 0,
});

if (error) {
  console.error("저장한 프로젝트 조회 실패:", error);
  return;
}

console.log(`저장한 프로젝트 ${projects.length}개`);

// 다음 페이지 조회
const { projects: nextProjects } = await fetchSavedProjects({
  limit: 20,
  offset: 20,
});
```

**동작 방식:**
- 저장한 순서대로 정렬 (최신 저장 순)
- 페이지네이션 지원
- 인증된 사용자만 접근 가능

---

## SQL 함수

### 1. `odd.v1_toggle_project_bookmark`

프로젝트 저장/해제를 토글하는 SQL 함수입니다.

**매개변수:**
- `p_project_id` (uuid): 프로젝트 ID

**반환값:**
- `is_bookmarked` (boolean): 현재 저장 상태
- `bookmarks_count` (integer): 프로젝트의 총 저장 수

**사용 위치:**
- `toggleProjectBookmark` API 함수에서 호출

---

### 2. `odd.v1_check_project_bookmark`

프로젝트 저장 상태를 확인하는 SQL 함수입니다.

**매개변수:**
- `p_project_id` (uuid): 프로젝트 ID

**반환값:**
- `boolean`: 저장 여부 (인증되지 않은 경우 false)

**사용 위치:**
- `checkProjectBookmark` API 함수에서 호출

---

### 3. `odd.v1_fetch_saved_projects`

저장한 프로젝트 목록을 조회하는 SQL 함수입니다.

**매개변수:**
- `p_limit` (integer, 기본값: 50): 조회 개수 제한
- `p_offset` (integer, 기본값: 0): 페이지네이션 오프셋

**반환값:**
- 프로젝트 상세 정보 (작성자 정보, 저장 일시 포함)

**사용 위치:**
- `fetchSavedProjects` API 함수에서 호출

---

## 프론트엔드 사용 예시

### 프로젝트 상세 페이지에서 저장 기능 사용

```typescript
import { useState, useEffect } from "react";
import { toggleProjectBookmark, checkProjectBookmark } from "@/entities/project";

function ProjectDetailPage() {
  const { id } = useParams();
  const { isAuthenticated } = useUserStore();
  const [isBookmarked, setIsBookmarked] = useState(false);

  // 저장 상태 확인
  useEffect(() => {
    if (!id || !isAuthenticated) {
      setIsBookmarked(false);
      return;
    }

    const checkBookmark = async () => {
      const { isBookmarked: bookmarked, error } = await checkProjectBookmark(id);
      if (!error) {
        setIsBookmarked(bookmarked);
      }
    };

    checkBookmark();
  }, [id, isAuthenticated]);

  // 저장 핸들러
  const handleBookmark = async () => {
    if (!isAuthenticated) {
      // 로그인 모달 표시
      return;
    }

    if (!id) return;

    // 낙관적 업데이트
    const previousIsBookmarked = isBookmarked;
    setIsBookmarked(!previousIsBookmarked);

    try {
      const { isBookmarked: newIsBookmarked, error } = await toggleProjectBookmark(id);

      if (error) {
        // 에러 발생 시 이전 상태로 롤백
        setIsBookmarked(previousIsBookmarked);
        return;
      }

      setIsBookmarked(newIsBookmarked);
    } catch (err) {
      // 에러 발생 시 이전 상태로 롤백
      setIsBookmarked(previousIsBookmarked);
    }
  };

  return (
    <button onClick={handleBookmark}>
      <Bookmark className={isBookmarked ? "fill-current" : ""} />
      저장
    </button>
  );
}
```

### 저장한 프로젝트 목록 페이지

```typescript
import { useState, useEffect } from "react";
import { fetchSavedProjects } from "@/entities/project";
import type { Project } from "@/entities/project";

function SavedProjectsPage() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [offset, setOffset] = useState(0);
  const [hasMore, setHasMore] = useState(true);

  useEffect(() => {
    loadProjects();
  }, []);

  const loadProjects = async () => {
    setIsLoading(true);
    const { projects: savedProjects, error } = await fetchSavedProjects({
      limit: 20,
      offset: 0,
    });

    if (error) {
      console.error("저장한 프로젝트 조회 실패:", error);
      setIsLoading(false);
      return;
    }

    setProjects(savedProjects);
    setHasMore(savedProjects.length === 20);
    setIsLoading(false);
  };

  const loadMore = async () => {
    if (!hasMore || isLoading) return;

    const { projects: moreProjects, error } = await fetchSavedProjects({
      limit: 20,
      offset: projects.length,
    });

    if (error) {
      console.error("추가 프로젝트 조회 실패:", error);
      return;
    }

    setProjects((prev) => [...prev, ...moreProjects]);
    setHasMore(moreProjects.length === 20);
  };

  return (
    <div>
      <h1>저장한 프로젝트</h1>
      {projects.map((project) => (
        <ProjectCard key={project.id} project={project} />
      ))}
      {hasMore && (
        <button onClick={loadMore}>더 보기</button>
      )}
    </div>
  );
}
```

---

## 보안 고려사항

1. **인증 필요**: 저장 기능은 인증된 사용자만 사용 가능
2. **RLS 정책**: 사용자는 자신이 저장한 프로젝트만 조회/삭제 가능
3. **자동 사용자 확인**: SQL 함수에서 `auth.uid()`를 사용하여 현재 사용자 자동 확인

---

## 실행 방법

### SQL 파일 실행

```bash
psql "postgresql://postgres.xyqpggpilgcdsawuvpzn:ZNDqDunnaydr0aFQ@aws-0-ap-northeast-2.pooler.supabase.com:5432/postgres" -f docs/sql/038_create_project_bookmarks.sql
```

---

## 관련 파일

- **SQL 파일**: `docs/sql/038_create_project_bookmarks.sql`
- **API 함수**: `src/entities/project/api/project.api.ts`
- **프로젝트 상세 페이지**: `src/pages/project/ProjectDetailPage.tsx`
- **프로젝트 타입**: `src/entities/project/model/project.types.ts`


