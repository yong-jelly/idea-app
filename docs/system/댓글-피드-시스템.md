# ëŒ“ê¸€-í”¼ë“œ ì‹œìŠ¤í…œ

## ê°œìš”

í”¼ë“œ(í¬ìŠ¤íŠ¸)ì™€ ëŒ“ê¸€ ì‹œìŠ¤í…œì€ ì‚¬ìš©ìê°€ ì½˜í…ì¸ ë¥¼ ê³µìœ í•˜ê³  ì†Œí†µí•  ìˆ˜ ìˆëŠ” í•µì‹¬ ê¸°ëŠ¥ì…ë‹ˆë‹¤. í¬ìŠ¤íŠ¸ ì‘ì„±, í”¼ë“œ ì¡°íšŒ, ëŒ“ê¸€ ë° ë‹µê¸€ ì‘ì„±, ì¢‹ì•„ìš”/ë¶ë§ˆí¬ ë“±ì˜ ì¸í„°ë™ì…˜ì„ ì§€ì›í•©ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

- **í¬ìŠ¤íŠ¸ ì‘ì„±**: í…ìŠ¤íŠ¸, í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸, ë§ˆì¼ìŠ¤í†¤, ê¸°ëŠ¥ ìˆ˜ë½ ë“± ë‹¤ì–‘í•œ íƒ€ì…ì˜ í¬ìŠ¤íŠ¸ ì‘ì„±
- **í”¼ë“œ ì¡°íšŒ**: íƒ€ì„ë¼ì¸ í˜•íƒœì˜ í”¼ë“œ ì¡°íšŒ (í•„í„°ë§, ì •ë ¬, í˜ì´ì§€ë„¤ì´ì…˜ ì§€ì›)
- **ëŒ“ê¸€ ì‹œìŠ¤í…œ**: ìµœëŒ€ 3ë‹¨ê³„ ê¹Šì´ì˜ ì¤‘ì²© ëŒ“ê¸€ (ì›ëŒ“ê¸€, ëŒ€ëŒ“ê¸€, ëŒ€ëŒ€ëŒ“ê¸€)
- **ì¸í„°ë™ì…˜**: ì¢‹ì•„ìš”, ë¶ë§ˆí¬, ëŒ“ê¸€ ì‘ì„±
- **ë©˜ì…˜**: í¬ìŠ¤íŠ¸ ë° ëŒ“ê¸€ì—ì„œ ì‚¬ìš©ì ë©˜ì…˜(@username) ì§€ì›
- **ì´ë¯¸ì§€ ì²¨ë¶€**: í¬ìŠ¤íŠ¸ ìµœëŒ€ 4ì¥, ëŒ“ê¸€ ìµœëŒ€ 1ì¥
- **ë§í¬ í”„ë¦¬ë·°**: URL ìë™ ê°ì§€ ë° í”„ë¦¬ë·° í‘œì‹œ

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 1. í¬ìŠ¤íŠ¸ í…Œì´ë¸” (`odd.tbl_posts`)

í¬ìŠ¤íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” í•µì‹¬ í…Œì´ë¸”ì…ë‹ˆë‹¤.

#### ìŠ¤í‚¤ë§ˆ

```sql
CREATE TABLE odd.tbl_posts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    author_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    
    -- í¬ìŠ¤íŠ¸ íƒ€ì…
    type text NOT NULL CHECK (type IN ('text', 'project_update', 'milestone', 'feature_accepted')),
    
    -- ì½˜í…ì¸ 
    content text NOT NULL,
    images jsonb DEFAULT '[]'::jsonb,  -- ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 4ì¥)
    link_preview jsonb,  -- {url, title, description, image, domain}
    
    -- í”„ë¡œì íŠ¸ ì—°ê´€ (project_update, milestone, feature_acceptedìš©)
    project_id uuid REFERENCES odd.projects(id) ON DELETE SET NULL,
    milestone_title text,
    feature_title text,
    
    -- ì¶œì²˜ ì •ë³´
    source_type text DEFAULT 'direct' CHECK (source_type IN ('direct', 'project', 'community')),
    source_id uuid,  -- project_id ë˜ëŠ” community_id
    source_name text,  -- ì¶œì²˜ ì´ë¦„ (ë¹„ì •ê·œí™”)
    source_emoji text,  -- ì¶œì²˜ ì´ëª¨ì§€ (ë¹„ì •ê·œí™”)
    
    -- í†µê³„ (ë¹„ì •ê·œí™”)
    likes_count integer DEFAULT 0 NOT NULL,
    comments_count integer DEFAULT 0 NOT NULL,
    bookmarks_count integer DEFAULT 0 NOT NULL,
    
    -- ìƒíƒœ
    is_pinned boolean DEFAULT false,
    is_deleted boolean DEFAULT false,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at timestamptz DEFAULT now() NOT NULL,
    updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### ì£¼ìš” ì»¬ëŸ¼ ì„¤ëª…

| ì»¬ëŸ¼ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `id` | uuid | âœ… | í¬ìŠ¤íŠ¸ ê³ ìœ  ID (ìë™ ìƒì„±) |
| `author_id` | bigint | âœ… | ì‘ì„±ì ID (`odd.tbl_users.id` ì°¸ì¡°) |
| `type` | text | âœ… | í¬ìŠ¤íŠ¸ íƒ€ì…: `text`, `project_update`, `milestone`, `feature_accepted` |
| `content` | text | âœ… | í¬ìŠ¤íŠ¸ ë‚´ìš© |
| `images` | jsonb | - | ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 4ì¥), ì˜ˆ: `["url1", "url2"]` |
| `link_preview` | jsonb | - | ë§í¬ í”„ë¦¬ë·° ì •ë³´: `{url, title, description, image, domain}` |
| `project_id` | uuid | - | ì—°ê´€ í”„ë¡œì íŠ¸ ID (í”„ë¡œì íŠ¸ ê´€ë ¨ íƒ€ì…ìš©) |
| `milestone_title` | text | - | ë§ˆì¼ìŠ¤í†¤ ì œëª© (`milestone` íƒ€ì…ìš©) |
| `feature_title` | text | - | ê¸°ëŠ¥ ì œëª© (`feature_accepted` íƒ€ì…ìš©) |
| `source_type` | text | - | ì¶œì²˜ íƒ€ì…: `direct`, `project`, `community` |
| `source_id` | uuid | - | ì¶œì²˜ ID (í”„ë¡œì íŠ¸ ë˜ëŠ” ì»¤ë®¤ë‹ˆí‹° ID) |
| `source_name` | text | - | ì¶œì²˜ ì´ë¦„ (ë¹„ì •ê·œí™”, UI í‘œì‹œìš©) |
| `source_emoji` | text | - | ì¶œì²˜ ì´ëª¨ì§€ (ë¹„ì •ê·œí™”, UI í‘œì‹œìš©) |
| `likes_count` | integer | âœ… | ì¢‹ì•„ìš” ìˆ˜ (ë¹„ì •ê·œí™”, íŠ¸ë¦¬ê±°ë¡œ ìë™ ë™ê¸°í™”) |
| `comments_count` | integer | âœ… | ëŒ“ê¸€ ìˆ˜ (ë¹„ì •ê·œí™”, íŠ¸ë¦¬ê±°ë¡œ ìë™ ë™ê¸°í™”) |
| `bookmarks_count` | integer | âœ… | ë¶ë§ˆí¬ ìˆ˜ (ë¹„ì •ê·œí™”, íŠ¸ë¦¬ê±°ë¡œ ìë™ ë™ê¸°í™”) |
| `is_pinned` | boolean | âœ… | ìƒë‹¨ ê³ ì • ì—¬ë¶€ |
| `is_deleted` | boolean | âœ… | ì‚­ì œ ì—¬ë¶€ (ì†Œí”„íŠ¸ ì‚­ì œ) |
| `created_at` | timestamptz | âœ… | ìƒì„±ì¼ì‹œ |
| `updated_at` | timestamptz | âœ… | ìˆ˜ì •ì¼ì‹œ (íŠ¸ë¦¬ê±°ë¡œ ìë™ ì—…ë°ì´íŠ¸) |

#### ì¸ë±ìŠ¤

| ì¸ë±ìŠ¤ëª… | ì»¬ëŸ¼ | ìš©ë„ |
|---------|------|------|
| `idx_tbl_posts_author_id` | `author_id` | ì‚¬ìš©ìë³„ í¬ìŠ¤íŠ¸ ì¡°íšŒ |
| `idx_tbl_posts_created_at` | `created_at DESC` | íƒ€ì„ë¼ì¸ ì •ë ¬ |
| `idx_tbl_posts_project_id` | `project_id` | í”„ë¡œì íŠ¸ë³„ í¬ìŠ¤íŠ¸ ì¡°íšŒ |
| `idx_tbl_posts_source` | `source_type, source_id` | ì¶œì²˜ë³„ í•„í„°ë§ |
| `idx_tbl_posts_type` | `type` | í¬ìŠ¤íŠ¸ íƒ€ì…ë³„ ì¡°íšŒ |
| `idx_tbl_posts_active` | `created_at DESC` (WHERE `is_deleted = false`) | í™œì„± í¬ìŠ¤íŠ¸ë§Œ ì¡°íšŒ |
| `idx_tbl_posts_pinned` | `is_pinned` (WHERE `is_pinned = true`) | ê³ ì • í¬ìŠ¤íŠ¸ ì¡°íšŒ |
| `idx_tbl_posts_likes` | `likes_count DESC` | ì¸ê¸°ìˆœ ì •ë ¬ |
| `idx_tbl_posts_images` | `images` (GIN) | JSON ê²€ìƒ‰ìš© |

#### íŠ¸ë¦¬ê±°

- **`trigger_tbl_posts_updated_at`**: `updated_at` ìë™ ì—…ë°ì´íŠ¸

---

### 2. ëŒ“ê¸€ í…Œì´ë¸” (`odd.tbl_comments`)

í¬ìŠ¤íŠ¸ì— ëŒ€í•œ ëŒ“ê¸€ì„ ì €ì¥í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤. ìµœëŒ€ 3ë‹¨ê³„ ê¹Šì´ì˜ ì¤‘ì²© ëŒ“ê¸€ì„ ì§€ì›í•©ë‹ˆë‹¤.

#### ìŠ¤í‚¤ë§ˆ

```sql
CREATE TABLE odd.tbl_comments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    post_id uuid NOT NULL REFERENCES odd.tbl_posts(id) ON DELETE CASCADE,
    parent_id uuid REFERENCES odd.tbl_comments(id) ON DELETE CASCADE,
    author_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    
    -- ì½˜í…ì¸ 
    content text NOT NULL,
    images jsonb DEFAULT '[]'::jsonb,  -- ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 1ì¥)
    link_preview jsonb,  -- {url, title, description, image, domain}
    
    -- ëŒ“ê¸€ êµ¬ì¡°
    depth smallint DEFAULT 0 NOT NULL CHECK (depth >= 0 AND depth <= 2),
    
    -- í†µê³„ (ë¹„ì •ê·œí™”)
    likes_count integer DEFAULT 0 NOT NULL,
    
    -- ìƒíƒœ
    is_deleted boolean DEFAULT false,
    
    -- íƒ€ì„ìŠ¤íƒ¬í”„
    created_at timestamptz DEFAULT now() NOT NULL,
    updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### ì£¼ìš” ì»¬ëŸ¼ ì„¤ëª…

| ì»¬ëŸ¼ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `id` | uuid | âœ… | ëŒ“ê¸€ ê³ ìœ  ID (ìë™ ìƒì„±) |
| `post_id` | uuid | âœ… | í¬ìŠ¤íŠ¸ ID (`odd.tbl_posts.id` ì°¸ì¡°) |
| `parent_id` | uuid | - | ë¶€ëª¨ ëŒ“ê¸€ ID (ë‹µê¸€ì¸ ê²½ìš°, `odd.tbl_comments.id` ì°¸ì¡°) |
| `author_id` | bigint | âœ… | ì‘ì„±ì ID (`odd.tbl_users.id` ì°¸ì¡°) |
| `content` | text | âœ… | ëŒ“ê¸€ ë‚´ìš© |
| `images` | jsonb | - | ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 1ì¥), ì˜ˆ: `["url1"]` |
| `link_preview` | jsonb | - | ë§í¬ í”„ë¦¬ë·° ì •ë³´ |
| `depth` | smallint | âœ… | ëŒ“ê¸€ ê¹Šì´ (0: ì›ëŒ“ê¸€, 1: ëŒ€ëŒ“ê¸€, 2: ëŒ€ëŒ€ëŒ“ê¸€) |
| `likes_count` | integer | âœ… | ì¢‹ì•„ìš” ìˆ˜ (ë¹„ì •ê·œí™”, íŠ¸ë¦¬ê±°ë¡œ ìë™ ë™ê¸°í™”) |
| `is_deleted` | boolean | âœ… | ì‚­ì œ ì—¬ë¶€ (ì†Œí”„íŠ¸ ì‚­ì œ, í•˜ìœ„ ë‹µê¸€ ìœ ì§€) |
| `created_at` | timestamptz | âœ… | ìƒì„±ì¼ì‹œ |
| `updated_at` | timestamptz | âœ… | ìˆ˜ì •ì¼ì‹œ (íŠ¸ë¦¬ê±°ë¡œ ìë™ ì—…ë°ì´íŠ¸) |

#### ëŒ“ê¸€ ê¹Šì´ êµ¬ì¡°

```
ì›ê¸€ (Post)
â”œâ”€â”€ ëŒ“ê¸€ (depth: 0) â† ì›ëŒ“ê¸€, ë‹µê¸€ ê°€ëŠ¥
â”‚   â”œâ”€â”€ ëŒ€ëŒ“ê¸€ (depth: 1) â† ë‹µê¸€ ê°€ëŠ¥
â”‚   â”‚   â”œâ”€â”€ ëŒ€ëŒ€ëŒ“ê¸€ (depth: 2) â† ìµœëŒ€ ê¹Šì´, ë‹µê¸€ ë¶ˆê°€
â”‚   â”‚   â””â”€â”€ ëŒ€ëŒ€ëŒ“ê¸€ (depth: 2)
â”‚   â””â”€â”€ ëŒ€ëŒ“ê¸€ (depth: 1)
â””â”€â”€ ëŒ“ê¸€ (depth: 0)
```

#### ì¸ë±ìŠ¤

| ì¸ë±ìŠ¤ëª… | ì»¬ëŸ¼ | ìš©ë„ |
|---------|------|------|
| `idx_tbl_comments_post_id` | `post_id, created_at` | í¬ìŠ¤íŠ¸ë³„ ëŒ“ê¸€ ì¡°íšŒ |
| `idx_tbl_comments_parent_id` | `parent_id` | ë¶€ëª¨ ëŒ“ê¸€ë³„ ë‹µê¸€ ì¡°íšŒ |
| `idx_tbl_comments_author_id` | `author_id` | ì‘ì„±ìë³„ ëŒ“ê¸€ ì¡°íšŒ |
| `idx_tbl_comments_active` | `post_id, created_at` (WHERE `is_deleted = false`) | í™œì„± ëŒ“ê¸€ë§Œ ì¡°íšŒ |
| `idx_tbl_comments_depth` | `post_id, depth` | ëŒ“ê¸€ depthë³„ ì¡°íšŒ |

#### íŠ¸ë¦¬ê±°

- **`trigger_tbl_comments_updated_at`**: `updated_at` ìë™ ì—…ë°ì´íŠ¸
- **`trigger_increment_post_comments`**: ëŒ“ê¸€ ìƒì„± ì‹œ í¬ìŠ¤íŠ¸ì˜ `comments_count` ì¦ê°€
- **`trigger_decrement_post_comments`**: ëŒ“ê¸€ ì‚­ì œ ì‹œ í¬ìŠ¤íŠ¸ì˜ `comments_count` ê°ì†Œ
- **`trigger_set_comment_depth`**: ëŒ“ê¸€ ìƒì„± ì‹œ `depth` ìë™ ê³„ì‚°

---

### 3. ì¸í„°ë™ì…˜ í…Œì´ë¸”ë“¤

#### 3.1 í¬ìŠ¤íŠ¸ ì¢‹ì•„ìš” í…Œì´ë¸” (`odd.tbl_post_likes`)

```sql
CREATE TABLE odd.tbl_post_likes (
    post_id uuid NOT NULL REFERENCES odd.tbl_posts(id) ON DELETE CASCADE,
    user_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now() NOT NULL,
    PRIMARY KEY (post_id, user_id)
);
```

**íŠ¸ë¦¬ê±°:**
- `trigger_increment_post_likes`: ì¢‹ì•„ìš” ì¶”ê°€ ì‹œ `likes_count` ì¦ê°€
- `trigger_decrement_post_likes`: ì¢‹ì•„ìš” ì œê±° ì‹œ `likes_count` ê°ì†Œ

#### 3.2 í¬ìŠ¤íŠ¸ ë¶ë§ˆí¬ í…Œì´ë¸” (`odd.tbl_post_bookmarks`)

```sql
CREATE TABLE odd.tbl_post_bookmarks (
    post_id uuid NOT NULL REFERENCES odd.tbl_posts(id) ON DELETE CASCADE,
    user_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now() NOT NULL,
    PRIMARY KEY (post_id, user_id)
);
```

**íŠ¸ë¦¬ê±°:**
- `trigger_increment_post_bookmarks`: ë¶ë§ˆí¬ ì¶”ê°€ ì‹œ `bookmarks_count` ì¦ê°€
- `trigger_decrement_post_bookmarks`: ë¶ë§ˆí¬ ì œê±° ì‹œ `bookmarks_count` ê°ì†Œ

#### 3.3 ëŒ“ê¸€ ì¢‹ì•„ìš” í…Œì´ë¸” (`odd.tbl_comment_likes`)

```sql
CREATE TABLE odd.tbl_comment_likes (
    comment_id uuid NOT NULL REFERENCES odd.tbl_comments(id) ON DELETE CASCADE,
    user_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now() NOT NULL,
    PRIMARY KEY (comment_id, user_id)
);
```

**íŠ¸ë¦¬ê±°:**
- `trigger_increment_comment_likes`: ì¢‹ì•„ìš” ì¶”ê°€ ì‹œ `likes_count` ì¦ê°€
- `trigger_decrement_comment_likes`: ì¢‹ì•„ìš” ì œê±° ì‹œ `likes_count` ê°ì†Œ

#### 3.4 ë©˜ì…˜ í…Œì´ë¸” (`odd.tbl_mentions`)

```sql
CREATE TABLE odd.tbl_mentions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ë©˜ì…˜ ëŒ€ìƒ (í¬ìŠ¤íŠ¸ ë˜ëŠ” ëŒ“ê¸€)
    post_id uuid REFERENCES odd.tbl_posts(id) ON DELETE CASCADE,
    comment_id uuid REFERENCES odd.tbl_comments(id) ON DELETE CASCADE,
    
    -- ë©˜ì…˜ëœ ì‚¬ìš©ì
    mentioned_user_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    
    -- ë©˜ì…˜í•œ ì‚¬ìš©ì
    mentioner_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    
    -- ì½ìŒ ì—¬ë¶€ (ì•Œë¦¼ìš©)
    is_read boolean DEFAULT false,
    
    created_at timestamptz DEFAULT now() NOT NULL,
    
    -- í•˜ë‚˜ì˜ ì»¨í…ìŠ¤íŠ¸ë§Œ ê°€ì ¸ì•¼ í•¨
    CONSTRAINT chk_mention_context CHECK (
        (post_id IS NOT NULL AND comment_id IS NULL) OR
        (post_id IS NULL AND comment_id IS NOT NULL)
    )
);
```

**ì¸ë±ìŠ¤:**
- `idx_tbl_mentions_mentioned_user`: ë©˜ì…˜ëœ ì‚¬ìš©ìë³„ ì¡°íšŒ (ì•Œë¦¼ìš©)
- `idx_tbl_mentions_unread`: ì½ì§€ ì•Šì€ ë©˜ì…˜ë§Œ ì¡°íšŒ
- `idx_tbl_mentions_post_id`: í¬ìŠ¤íŠ¸ë³„ ë©˜ì…˜ ì¡°íšŒ
- `idx_tbl_mentions_comment_id`: ëŒ“ê¸€ë³„ ë©˜ì…˜ ì¡°íšŒ

---

## RPC í•¨ìˆ˜

### 1. í¬ìŠ¤íŠ¸ ìƒì„± (`odd.v1_create_post`)

í¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

#### í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜

```sql
CREATE OR REPLACE FUNCTION odd.v1_create_post(
    p_type text,
    p_content text,
    p_images jsonb DEFAULT '[]'::jsonb,
    p_link_preview jsonb DEFAULT NULL,
    p_project_id uuid DEFAULT NULL,
    p_milestone_title text DEFAULT NULL,
    p_feature_title text DEFAULT NULL,
    p_source_type text DEFAULT 'direct',
    p_source_id uuid DEFAULT NULL,
    p_source_name text DEFAULT NULL,
    p_source_emoji text DEFAULT NULL
)
RETURNS odd.tbl_posts
```

#### ë§¤ê°œë³€ìˆ˜

| ë§¤ê°œë³€ìˆ˜ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|---------|------|------|------|
| `p_type` | text | âœ… | í¬ìŠ¤íŠ¸ íƒ€ì…: `text`, `project_update`, `milestone`, `feature_accepted` |
| `p_content` | text | âœ… | í¬ìŠ¤íŠ¸ ë‚´ìš© |
| `p_images` | jsonb | - | ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 4ì¥) |
| `p_link_preview` | jsonb | - | ë§í¬ í”„ë¦¬ë·° ì •ë³´ |
| `p_project_id` | uuid | - | ì—°ê´€ í”„ë¡œì íŠ¸ ID (í”„ë¡œì íŠ¸ ê´€ë ¨ íƒ€ì…ìš©) |
| `p_milestone_title` | text | - | ë§ˆì¼ìŠ¤í†¤ ì œëª© (`milestone` íƒ€ì…ìš©) |
| `p_feature_title` | text | - | ê¸°ëŠ¥ ì œëª© (`feature_accepted` íƒ€ì…ìš©) |
| `p_source_type` | text | - | ì¶œì²˜ íƒ€ì…: `direct`, `project`, `community` |
| `p_source_id` | uuid | - | ì¶œì²˜ ID |
| `p_source_name` | text | - | ì¶œì²˜ ì´ë¦„ |
| `p_source_emoji` | text | - | ì¶œì²˜ ì´ëª¨ì§€ |

#### ì‚¬ìš© ì˜ˆì‹œ

```typescript
import { supabase } from "@/shared/lib/supabase";

// ì¼ë°˜ í…ìŠ¤íŠ¸ í¬ìŠ¤íŠ¸
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_create_post', {
    p_type: 'text',
    p_content: 'ì˜¤ëŠ˜ ë“œë””ì–´ AI ì½”ë“œ ë¦¬ë·° ë„êµ¬ì˜ ë² íƒ€ ë²„ì „ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤! ğŸ‰',
    p_images: ['url1', 'url2']::jsonb
  });

// í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸ í¬ìŠ¤íŠ¸
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_create_post', {
    p_type: 'project_update',
    p_content: 'ì˜¤í”ˆì†ŒìŠ¤ API ê²Œì´íŠ¸ì›¨ì´ v2.0ì„ ë¦´ë¦¬ì¦ˆí–ˆìŠµë‹ˆë‹¤!',
    p_project_id: 'project-uuid-here',
    p_source_type: 'project',
    p_source_id: 'project-uuid-here',
    p_source_name: 'ì˜¤í”ˆì†ŒìŠ¤ API ê²Œì´íŠ¸ì›¨ì´',
    p_source_emoji: 'ğŸ”Œ'
  });
```

#### ê²€ì¦ ê·œì¹™

- í¬ìŠ¤íŠ¸ íƒ€ì…ì´ ìœ íš¨í•œì§€ í™•ì¸
- ì¶œì²˜ íƒ€ì…ì´ ìœ íš¨í•œì§€ í™•ì¸
- ì´ë¯¸ì§€ ê°œìˆ˜ê°€ 4ì¥ ì´í•˜ì¸ì§€ í™•ì¸
- í”„ë¡œì íŠ¸ ì—°ê´€ íƒ€ì…ì€ `project_id` í•„ìˆ˜
- `milestone` íƒ€ì…ì€ `milestone_title` í•„ìˆ˜
- `feature_accepted` íƒ€ì…ì€ `feature_title` í•„ìˆ˜

---

### 2. í”¼ë“œ ì¡°íšŒ (`odd.v1_fetch_feed`)

í”¼ë“œ í¬ìŠ¤íŠ¸ ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

#### í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜

```sql
CREATE OR REPLACE FUNCTION odd.v1_fetch_feed(
    p_type text DEFAULT NULL,
    p_source_type text DEFAULT NULL,
    p_project_id uuid DEFAULT NULL,
    p_limit integer DEFAULT 50,
    p_offset integer DEFAULT 0,
    p_order_by text DEFAULT 'created_at',
    p_order_direction text DEFAULT 'desc'
)
RETURNS TABLE (
    -- í¬ìŠ¤íŠ¸ ì •ë³´
    id uuid,
    author_id bigint,
    type text,
    content text,
    images jsonb,
    link_preview jsonb,
    project_id uuid,
    milestone_title text,
    feature_title text,
    source_type text,
    source_id uuid,
    source_name text,
    source_emoji text,
    likes_count integer,
    comments_count integer,
    bookmarks_count integer,
    is_pinned boolean,
    created_at timestamptz,
    updated_at timestamptz,
    -- ì‘ì„±ì ì •ë³´
    author_username text,
    author_display_name text,
    author_avatar_url text,
    -- í˜„ì¬ ì‚¬ìš©ì ì¸í„°ë™ì…˜ ìƒíƒœ
    is_liked boolean,
    is_bookmarked boolean
)
```

#### ë§¤ê°œë³€ìˆ˜

| ë§¤ê°œë³€ìˆ˜ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|---------|------|------|------|
| `p_type` | text | - | í¬ìŠ¤íŠ¸ íƒ€ì… í•„í„° |
| `p_source_type` | text | - | ì¶œì²˜ íƒ€ì… í•„í„° |
| `p_project_id` | uuid | - | í”„ë¡œì íŠ¸ ID í•„í„° |
| `p_limit` | integer | - | ì¡°íšŒ ê°œìˆ˜ ì œí•œ (ê¸°ë³¸ê°’: 50, ìµœëŒ€: 100) |
| `p_offset` | integer | - | í˜ì´ì§€ë„¤ì´ì…˜ ì˜¤í”„ì…‹ (ê¸°ë³¸ê°’: 0) |
| `p_order_by` | text | - | ì •ë ¬ ê¸°ì¤€: `created_at`, `likes_count`, `comments_count` |
| `p_order_direction` | text | - | ì •ë ¬ ë°©í–¥: `asc`, `desc` |

#### ì‚¬ìš© ì˜ˆì‹œ

```typescript
import { supabase } from "@/shared/lib/supabase";

// ìµœì‹  í”¼ë“œ ì¡°íšŒ
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_fetch_feed', {
    p_limit: 20,
    p_order_by: 'created_at',
    p_order_direction: 'desc'
  });

// í”„ë¡œì íŠ¸ë³„ í¬ìŠ¤íŠ¸ ì¡°íšŒ
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_fetch_feed', {
    p_project_id: 'project-uuid-here',
    p_limit: 20
  });

// ì¸ê¸° í¬ìŠ¤íŠ¸ ì¡°íšŒ
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_fetch_feed', {
    p_limit: 20,
    p_order_by: 'likes_count',
    p_order_direction: 'desc'
  });
```

#### ë°˜í™˜ ë°ì´í„° êµ¬ì¡°

```typescript
interface FeedPost {
  // í¬ìŠ¤íŠ¸ ì •ë³´
  id: string;
  author_id: number;
  type: 'text' | 'project_update' | 'milestone' | 'feature_accepted';
  content: string;
  images: string[];
  link_preview?: {
    url: string;
    title: string;
    description: string;
    image: string;
    domain: string;
  };
  project_id?: string;
  milestone_title?: string;
  feature_title?: string;
  source_type: 'direct' | 'project' | 'community';
  source_id?: string;
  source_name?: string;
  source_emoji?: string;
  likes_count: number;
  comments_count: number;
  bookmarks_count: number;
  is_pinned: boolean;
  created_at: string;
  updated_at: string;
  
  // ì‘ì„±ì ì •ë³´
  author_username: string;
  author_display_name: string;
  author_avatar_url?: string;
  
  // í˜„ì¬ ì‚¬ìš©ì ì¸í„°ë™ì…˜ ìƒíƒœ
  is_liked: boolean;
  is_bookmarked: boolean;
}
```

---

### 3. í¬ìŠ¤íŠ¸ ì¸í„°ë™ì…˜ í•¨ìˆ˜ë“¤

#### 3.1 í¬ìŠ¤íŠ¸ ì¢‹ì•„ìš” í† ê¸€ (`odd.v1_toggle_post_like`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_toggle_post_like(
    p_post_id uuid
)
RETURNS jsonb
```

**ë°˜í™˜ê°’:**
```json
{
  "is_liked": boolean,
  "likes_count": integer
}
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_toggle_post_like', {
    p_post_id: 'post-uuid-here'
  });

// data: { is_liked: true, likes_count: 42 }
```

#### 3.2 í¬ìŠ¤íŠ¸ ë¶ë§ˆí¬ í† ê¸€ (`odd.v1_toggle_post_bookmark`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_toggle_post_bookmark(
    p_post_id uuid
)
RETURNS jsonb
```

**ë°˜í™˜ê°’:**
```json
{
  "is_bookmarked": boolean,
  "bookmarks_count": integer
}
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_toggle_post_bookmark', {
    p_post_id: 'post-uuid-here'
  });

// data: { is_bookmarked: true, bookmarks_count: 15 }
```

---

### 4. ëŒ“ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤

#### 4.1 ëŒ“ê¸€ ìƒì„± (`odd.v1_create_comment`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_create_comment(
    p_post_id uuid,
    p_content text,
    p_parent_id uuid DEFAULT NULL,
    p_images jsonb DEFAULT '[]'::jsonb,
    p_link_preview jsonb DEFAULT NULL
)
RETURNS odd.tbl_comments
```

**ë§¤ê°œë³€ìˆ˜:**

| ë§¤ê°œë³€ìˆ˜ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|---------|------|------|------|
| `p_post_id` | uuid | âœ… | í¬ìŠ¤íŠ¸ ID |
| `p_content` | text | âœ… | ëŒ“ê¸€ ë‚´ìš© |
| `p_parent_id` | uuid | - | ë¶€ëª¨ ëŒ“ê¸€ ID (ë‹µê¸€ì¸ ê²½ìš°) |
| `p_images` | jsonb | - | ì´ë¯¸ì§€ URL ë°°ì—´ (ìµœëŒ€ 1ì¥) |
| `p_link_preview` | jsonb | - | ë§í¬ í”„ë¦¬ë·° ì •ë³´ |

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
// ì›ëŒ“ê¸€ ìƒì„±
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_create_comment', {
    p_post_id: 'post-uuid-here',
    p_content: 'ì •ë§ ì¢‹ì€ í¬ìŠ¤íŠ¸ë„¤ìš”!'
  });

// ë‹µê¸€ ìƒì„±
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_create_comment', {
    p_post_id: 'post-uuid-here',
    p_content: 'ë™ê°í•©ë‹ˆë‹¤!',
    p_parent_id: 'parent-comment-uuid-here'
  });
```

**ê²€ì¦ ê·œì¹™:**
- í¬ìŠ¤íŠ¸ ì¡´ì¬ í™•ì¸
- ë¶€ëª¨ ëŒ“ê¸€ ì¡´ì¬ í™•ì¸ (ë‹µê¸€ì¸ ê²½ìš°)
- ìµœëŒ€ depth ê²€ì‚¬ (depth 2ê¹Œì§€ë§Œ í—ˆìš©)
- ì´ë¯¸ì§€ ê°œìˆ˜ ê²€ì‚¬ (ìµœëŒ€ 1ì¥)

#### 4.2 ëŒ“ê¸€ ì¡°íšŒ (`odd.v1_fetch_comments`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_fetch_comments(
    p_post_id uuid,
    p_limit integer DEFAULT 30,
    p_offset integer DEFAULT 0
)
RETURNS jsonb
```

**ë°˜í™˜ê°’ êµ¬ì¡°:**
```json
{
  "meta": {
    "post_id": "uuid",
    "limit": 30,
    "offset": 0,
    "server_time": "2024-01-01T00:00:00Z"
  },
  "pagination": {
    "total_count": 100,      // ì „ì²´ ëŒ“ê¸€ ê°œìˆ˜ (ë‹µê¸€ í¬í•¨)
    "top_level_count": 25,    // ìµœìƒìœ„ ëŒ“ê¸€ ê°œìˆ˜ (depth=0)
    "size": 30,
    "offset": 0,
    "has_more": true
  },
  "comments": [
    {
      "id": "uuid",
      "post_id": "uuid",
      "parent_id": "uuid",
      "author_id": 1,
      "content": "ëŒ“ê¸€ ë‚´ìš©",
      "images": [],
      "link_preview": null,
      "depth": 0,
      "likes_count": 5,
      "is_deleted": false,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": null,
      "author_username": "user1",
      "author_display_name": "ì‚¬ìš©ì1",
      "author_avatar_url": "url",
      "is_liked": false
    }
  ]
}
```

**í˜ì´ì§• ê·œì¹™:**
- `p_limit`: ìµœìƒìœ„ ëŒ“ê¸€(depth=0)ì˜ ê°œìˆ˜ ì œí•œ (ê¸°ë³¸ê°’: 30)
- `p_offset`: ìµœìƒìœ„ ëŒ“ê¸€ì˜ ì˜¤í”„ì…‹ (ê¸°ë³¸ê°’: 0)
- ë‹µê¸€(depth>0)ì€ ìë™ìœ¼ë¡œ í¬í•¨ë¨ (í˜ì´ì§• ëŒ€ìƒ ì•„ë‹˜)
- `pagination.has_more`: ë” ë¶ˆëŸ¬ì˜¬ ìµœìƒìœ„ ëŒ“ê¸€ì´ ìˆëŠ”ì§€ ì—¬ë¶€

**ì •ë ¬ ê·œì¹™:**
- ì›ëŒ“ê¸€(depth=0)ì€ ìµœì‹ ìˆœìœ¼ë¡œ í‘œì‹œ
- ë‹µê¸€(depth>0)ì€ ì˜¤ë˜ëœìˆœìœ¼ë¡œ í‘œì‹œ
- ê°™ì€ ë¶€ëª¨ì˜ ë‹µê¸€ë“¤ì€ ê·¸ë£¹í™”ë˜ì–´ í‘œì‹œ

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_fetch_comments', {
    p_post_id: 'post-uuid-here',
    p_limit: 30,
    p_offset: 0
  });

// ì‘ë‹µ íŒŒì‹±
const result = data as {
  meta: {
    post_id: string;
    limit: number;
    offset: number;
    server_time: string;
  };
  pagination: {
    total_count: number;
    top_level_count: number;
    size: number;
    offset: number;
    has_more: boolean;
  };
  comments: Comment[];
};
```

#### 4.3 ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€ (`odd.v1_toggle_comment_like`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_toggle_comment_like(
    p_comment_id uuid
)
RETURNS jsonb
```

**ë°˜í™˜ê°’:**
```json
{
  "is_liked": boolean,
  "likes_count": integer
}
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_toggle_comment_like', {
    p_comment_id: 'comment-uuid-here'
  });
```

#### 4.4 ëŒ“ê¸€ ìˆ˜ì • (`odd.v1_update_comment`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_update_comment(
    p_comment_id uuid,
    p_content text,
    p_images jsonb DEFAULT NULL,
    p_link_preview jsonb DEFAULT NULL
)
RETURNS odd.tbl_comments
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_update_comment', {
    p_comment_id: 'comment-uuid-here',
    p_content: 'ìˆ˜ì •ëœ ëŒ“ê¸€ ë‚´ìš©'
  });
```

**ê¶Œí•œ:**
- ì‘ì„±ìë§Œ ìˆ˜ì • ê°€ëŠ¥

#### 4.5 ëŒ“ê¸€ ì‚­ì œ (`odd.v1_delete_comment`)

```sql
CREATE OR REPLACE FUNCTION odd.v1_delete_comment(
    p_comment_id uuid
)
RETURNS boolean
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
const { data, error } = await supabase
  .schema('odd')
  .rpc('v1_delete_comment', {
    p_comment_id: 'comment-uuid-here'
  });
```

**ê¶Œí•œ:**
- ì‘ì„±ìë§Œ ì‚­ì œ ê°€ëŠ¥
- ì†Œí”„íŠ¸ ì‚­ì œë¡œ ì²˜ë¦¬ë˜ë©°, í•˜ìœ„ ë‹µê¸€ì€ ìœ ì§€ë¨
- íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ `comments_count` ê°ì†Œ

---

## í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš© ë°©ë²•

### 1. í¬ìŠ¤íŠ¸ ì‘ì„±

```typescript
import { supabase } from "@/shared/lib/supabase";

async function createPost(postData: {
  type: 'text' | 'project_update' | 'milestone' | 'feature_accepted';
  content: string;
  images?: string[];
  projectId?: string;
  milestoneTitle?: string;
  featureTitle?: string;
  sourceType?: 'direct' | 'project' | 'community';
  sourceId?: string;
  sourceName?: string;
  sourceEmoji?: string;
}) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_create_post', {
      p_type: postData.type,
      p_content: postData.content,
      p_images: postData.images || [],
      p_project_id: postData.projectId || null,
      p_milestone_title: postData.milestoneTitle || null,
      p_feature_title: postData.featureTitle || null,
      p_source_type: postData.sourceType || 'direct',
      p_source_id: postData.sourceId || null,
      p_source_name: postData.sourceName || null,
      p_source_emoji: postData.sourceEmoji || null
    });

  if (error) {
    console.error('í¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data };
}
```

### 2. í”¼ë“œ ì¡°íšŒ

```typescript
import { supabase } from "@/shared/lib/supabase";

async function fetchFeed(options: {
  type?: 'text' | 'project_update' | 'milestone' | 'feature_accepted';
  sourceType?: 'direct' | 'project' | 'community';
  projectId?: string;
  limit?: number;
  offset?: number;
  orderBy?: 'created_at' | 'likes_count' | 'comments_count';
  orderDirection?: 'asc' | 'desc';
}) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_fetch_feed', {
      p_type: options.type || null,
      p_source_type: options.sourceType || null,
      p_project_id: options.projectId || null,
      p_limit: options.limit || 50,
      p_offset: options.offset || 0,
      p_order_by: options.orderBy || 'created_at',
      p_order_direction: options.orderDirection || 'desc'
    });

  if (error) {
    console.error('í”¼ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data };
}
```

### 3. í¬ìŠ¤íŠ¸ ì¸í„°ë™ì…˜

```typescript
import { supabase } from "@/shared/lib/supabase";

// ì¢‹ì•„ìš” í† ê¸€
async function togglePostLike(postId: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_toggle_post_like', {
      p_post_id: postId
    });

  if (error) {
    console.error('ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data }; // { is_liked: boolean, likes_count: number }
}

// ë¶ë§ˆí¬ í† ê¸€
async function togglePostBookmark(postId: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_toggle_post_bookmark', {
      p_post_id: postId
    });

  if (error) {
    console.error('ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data }; // { is_bookmarked: boolean, bookmarks_count: number }
}
```

### 4. ëŒ“ê¸€ CRUD

```typescript
import { supabase } from "@/shared/lib/supabase";

// ëŒ“ê¸€ ìƒì„±
async function createComment(postId: string, content: string, parentId?: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_create_comment', {
      p_post_id: postId,
      p_content: content,
      p_parent_id: parentId || null
    });

  if (error) {
    console.error('ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data };
}

// ëŒ“ê¸€ ì¡°íšŒ
async function fetchComments(postId: string, limit = 100, offset = 0) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_fetch_comments', {
      p_post_id: postId,
      p_limit: limit,
      p_offset: offset
    });

  if (error) {
    console.error('ëŒ“ê¸€ ì¡°íšŒ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data };
}

// ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€
async function toggleCommentLike(commentId: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_toggle_comment_like', {
      p_comment_id: commentId
    });

  if (error) {
    console.error('ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data }; // { is_liked: boolean, likes_count: number }
}

// ëŒ“ê¸€ ìˆ˜ì •
async function updateComment(commentId: string, content: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_update_comment', {
      p_comment_id: commentId,
      p_content: content
    });

  if (error) {
    console.error('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data };
}

// ëŒ“ê¸€ ì‚­ì œ
async function deleteComment(commentId: string) {
  const { data, error } = await supabase
    .schema('odd')
    .rpc('v1_delete_comment', {
      p_comment_id: commentId
    });

  if (error) {
    console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
    return { error };
  }

  return { data }; // true
}
```

---

## UI/UX ê°€ì´ë“œë¼ì¸

### ëŒ“ê¸€ í‘œì‹œ ê·œì¹™

#### ë“¤ì—¬ì“°ê¸°

| Depth | Padding í´ë˜ìŠ¤ | ì„¤ëª… |
|-------|---------------|------|
| 0 | `px-4` | ê¸°ë³¸ ì—¬ë°± |
| 1 | `pl-14 pr-4` | ì¢Œì¸¡ 56px ë“¤ì—¬ì“°ê¸° |
| 2 | `pl-20 pr-4` | ì¢Œì¸¡ 80px ë“¤ì—¬ì“°ê¸° |

#### ì•„ë°”íƒ€ í¬ê¸°

| Depth | í¬ê¸° | í´ë˜ìŠ¤ |
|-------|------|--------|
| 0 | 40px | `md` |
| 1+ | 32px | `sm` |

#### í°íŠ¸ í¬ê¸°

| Depth | í¬ê¸° | í´ë˜ìŠ¤ |
|-------|------|--------|
| 0 | 15px | `text-[15px]` |
| 1+ | 14px | `text-sm` |

#### ë‹µê¸€ ë²„íŠ¼ í‘œì‹œ

- `depth < 2`: ë‹µê¸€ ë²„íŠ¼ í‘œì‹œ
- `depth === 2`: ë‹µê¸€ ë²„íŠ¼ ìˆ¨ê¹€ (ìµœëŒ€ ê¹Šì´)

### ëŒ“ê¸€ ì •ë ¬

1. **ì›ëŒ“ê¸€(depth=0)**: ìµœì‹ ìˆœìœ¼ë¡œ í‘œì‹œ
2. **ë‹µê¸€(depth>0)**: ë¶€ëª¨ ëŒ“ê¸€ ë°”ë¡œ ì•„ë˜ì— ì‹œê°„ìˆœ(ì˜¤ë˜ëœ ìˆœ)ìœ¼ë¡œ í‘œì‹œ
3. **ê°™ì€ ë¶€ëª¨ì˜ ë‹µê¸€ë“¤**: ê·¸ë£¹í™”ë˜ì–´ í‘œì‹œ

### í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤

- `âŒ˜+Enter` (Mac) / `Ctrl+Enter` (Windows): ëŒ“ê¸€ ì „ì†¡
- `Esc`: ëŒ“ê¸€ ì‘ì„± ì·¨ì†Œ

---

## ë³´ì•ˆ ë° ê¶Œí•œ (RLS)

### í¬ìŠ¤íŠ¸ í…Œì´ë¸” (`odd.tbl_posts`)

#### ì½ê¸° ê¶Œí•œ
- ëª¨ë“  ì‚¬ìš©ì(ê³µê°œ)ê°€ ì‚­ì œë˜ì§€ ì•Šì€ í¬ìŠ¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
- ì •ì±…: `"Anyone can read active posts"` (SELECT, TO public, USING (`is_deleted = false`))

#### ì“°ê¸° ê¶Œí•œ

**í¬ìŠ¤íŠ¸ ìƒì„± (INSERT):**
- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ í¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŒ
- `author_id`ê°€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ `tbl_users.id`ì™€ ì¼ì¹˜í•´ì•¼ í•¨
- ì •ì±…: `"Authenticated users can create posts"` (INSERT, TO authenticated)

**í¬ìŠ¤íŠ¸ ìˆ˜ì • (UPDATE):**
- ì‘ì„±ìë§Œ ìì‹ ì˜ í¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŒ
- ì •ì±…: `"Users can update own posts"` (UPDATE, TO authenticated)

**í¬ìŠ¤íŠ¸ ì‚­ì œ (DELETE):**
- ì‘ì„±ìë§Œ ìì‹ ì˜ í¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŒ
- ì •ì±…: `"Users can delete own posts"` (DELETE, TO authenticated)

### ëŒ“ê¸€ í…Œì´ë¸” (`odd.tbl_comments`)

#### ì½ê¸° ê¶Œí•œ
- ëª¨ë“  ì‚¬ìš©ìê°€ ëŒ“ê¸€ì„ ì½ì„ ìˆ˜ ìˆìŒ (ì‚­ì œëœ ëŒ“ê¸€ë„ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ ì½ì„ ìˆ˜ ìˆì§€ë§Œ, ë‚´ìš©ì€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë§ˆìŠ¤í‚¹)
- ì •ì±…: `"Anyone can read comments"` (SELECT, TO public, USING (true))

#### ì“°ê¸° ê¶Œí•œ

**ëŒ“ê¸€ ìƒì„± (INSERT):**
- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ì„ ìƒì„±í•  ìˆ˜ ìˆìŒ
- ì •ì±…: `"Authenticated users can create comments"` (INSERT, TO authenticated)

**ëŒ“ê¸€ ìˆ˜ì • (UPDATE):**
- ì‘ì„±ìë§Œ ìì‹ ì˜ ëŒ“ê¸€ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŒ
- ì •ì±…: `"Users can update own comments"` (UPDATE, TO authenticated)

**ëŒ“ê¸€ ì‚­ì œ (DELETE):**
- ì‘ì„±ìë§Œ ìì‹ ì˜ ëŒ“ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆìŒ
- ì •ì±…: `"Users can delete own comments"` (DELETE, TO authenticated)

### ì¸í„°ë™ì…˜ í…Œì´ë¸”ë“¤

#### í¬ìŠ¤íŠ¸ ì¢‹ì•„ìš” (`odd.tbl_post_likes`)
- ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì ê°€ëŠ¥
- ìƒì„±/ì‚­ì œ: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥

#### í¬ìŠ¤íŠ¸ ë¶ë§ˆí¬ (`odd.tbl_post_bookmarks`)
- ì½ê¸°: ìì‹ ì˜ ë¶ë§ˆí¬ë§Œ ì¡°íšŒ ê°€ëŠ¥
- ìƒì„±/ì‚­ì œ: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥

#### ëŒ“ê¸€ ì¢‹ì•„ìš” (`odd.tbl_comment_likes`)
- ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì ê°€ëŠ¥
- ìƒì„±/ì‚­ì œ: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥

#### ë©˜ì…˜ (`odd.tbl_mentions`)
- ì½ê¸°: ìì‹ ì´ ë©˜ì…˜ëœ ê²½ìš° ë˜ëŠ” ìì‹ ì´ ë©˜ì…˜í•œ ê²½ìš°ë§Œ ì¡°íšŒ ê°€ëŠ¥
- ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
- ìˆ˜ì •: ë©˜ì…˜ëœ ì‚¬ìš©ìë§Œ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ê°€ëŠ¥

---

## ì—ëŸ¬ ì²˜ë¦¬

### ì¼ë°˜ì ì¸ ì—ëŸ¬

#### ì¸ì¦ ì—ëŸ¬
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"`
- **ì›ì¸**: ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ì¸ì¦ì´ í•„ìš”í•œ ì‘ì—…ì„ ì‹œë„
- **í•´ê²°**: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### ì‚¬ìš©ì ì¡°íšŒ ì—ëŸ¬
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"`
- **ì›ì¸**: `tbl_users` í…Œì´ë¸”ì—ì„œ í˜„ì¬ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- **í•´ê²°**: ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„± í•„ìš”

#### ê¶Œí•œ ì—ëŸ¬
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"`
- **ì›ì¸**: ì‘ì„±ìê°€ ì•„ë‹Œ ì‚¬ìš©ìê°€ ìˆ˜ì •/ì‚­ì œ ì‹œë„
- **í•´ê²°**: ê¶Œí•œ í™•ì¸ í›„ ì‘ì—… ìˆ˜í–‰

### í¬ìŠ¤íŠ¸ ê´€ë ¨ ì—ëŸ¬

#### í¬ìŠ¤íŠ¸ íƒ€ì… ì—ëŸ¬
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ìœ íš¨í•˜ì§€ ì•Šì€ í¬ìŠ¤íŠ¸ íƒ€ì…ì…ë‹ˆë‹¤: {type}"`
- **ì›ì¸**: í—ˆìš©ë˜ì§€ ì•Šì€ í¬ìŠ¤íŠ¸ íƒ€ì… ì‚¬ìš©
- **í•´ê²°**: ìœ íš¨í•œ íƒ€ì… ì‚¬ìš©: `text`, `project_update`, `milestone`, `feature_accepted`

#### ì´ë¯¸ì§€ ê°œìˆ˜ ì´ˆê³¼
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ì¥ê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"`
- **ì›ì¸**: í¬ìŠ¤íŠ¸ì— 5ì¥ ì´ìƒì˜ ì´ë¯¸ì§€ ì²¨ë¶€ ì‹œë„
- **í•´ê²°**: ì´ë¯¸ì§€ ê°œìˆ˜ ì œí•œ ì¤€ìˆ˜

#### í”„ë¡œì íŠ¸ ì—°ê´€ íƒ€ì… ì—ëŸ¬
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"í”„ë¡œì íŠ¸ ì—°ê´€ íƒ€ì…ì€ project_idê°€ í•„ìš”í•©ë‹ˆë‹¤"`
- **ì›ì¸**: `project_update`, `milestone`, `feature_accepted` íƒ€ì…ì— `project_id` ì—†ìŒ
- **í•´ê²°**: `project_id` í•„ìˆ˜ ì œê³µ

### ëŒ“ê¸€ ê´€ë ¨ ì—ëŸ¬

#### ìµœëŒ€ ê¹Šì´ ì´ˆê³¼
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ìµœëŒ€ ëŒ“ê¸€ ê¹Šì´ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤ (ìµœëŒ€ 3ë‹¨ê³„)"`
- **ì›ì¸**: depth 2 ëŒ“ê¸€ì— ë‹µê¸€ ì‘ì„± ì‹œë„
- **í•´ê²°**: ìµœëŒ€ ê¹Šì´ ì œí•œ ì¤€ìˆ˜

#### ëŒ“ê¸€ ì´ë¯¸ì§€ ê°œìˆ˜ ì´ˆê³¼
- **ì—ëŸ¬ ë©”ì‹œì§€**: `"ëŒ“ê¸€ì—ëŠ” ìµœëŒ€ 1ì¥ì˜ ì´ë¯¸ì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"`
- **ì›ì¸**: ëŒ“ê¸€ì— 2ì¥ ì´ìƒì˜ ì´ë¯¸ì§€ ì²¨ë¶€ ì‹œë„
- **í•´ê²°**: ì´ë¯¸ì§€ ê°œìˆ˜ ì œí•œ ì¤€ìˆ˜

---

## ë°ì´í„° íë¦„

### í¬ìŠ¤íŠ¸ ìƒì„± íë¦„

```
1. ì‚¬ìš©ìê°€ í¬ìŠ¤íŠ¸ ì‘ì„± í¼ ì œì¶œ
   â†“
2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)
   â†“
3. v1_create_post RPC í•¨ìˆ˜ í˜¸ì¶œ
   â†“
4. ì¸ì¦ í™•ì¸ (auth.uid())
   â†“
5. ì‚¬ìš©ì ID ì¡°íšŒ (tbl_users)
   â†“
6. ë°ì´í„° ê²€ì¦ (íƒ€ì…, ì´ë¯¸ì§€ ê°œìˆ˜ ë“±)
   â†“
7. í¬ìŠ¤íŠ¸ ìƒì„± (tbl_posts INSERT)
   â†“
8. í¬ìŠ¤íŠ¸ ID ë°˜í™˜
   â†“
9. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í”¼ë“œ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
```

### ëŒ“ê¸€ ìƒì„± íë¦„

```
1. ì‚¬ìš©ìê°€ ëŒ“ê¸€ ì‘ì„± í¼ ì œì¶œ
   â†“
2. v1_create_comment RPC í•¨ìˆ˜ í˜¸ì¶œ
   â†“
3. ì¸ì¦ í™•ì¸ (auth.uid())
   â†“
4. ì‚¬ìš©ì ID ì¡°íšŒ (tbl_users)
   â†“
5. í¬ìŠ¤íŠ¸ ì¡´ì¬ í™•ì¸
   â†“
6. ë¶€ëª¨ ëŒ“ê¸€ í™•ì¸ ë° depth ê³„ì‚° (ë‹µê¸€ì¸ ê²½ìš°)
   â†“
7. ìµœëŒ€ depth ê²€ì‚¬ (depth < 2)
   â†“
8. ëŒ“ê¸€ ìƒì„± (tbl_comments INSERT)
   â†“
9. íŠ¸ë¦¬ê±° ì‹¤í–‰:
   - depth ìë™ ê³„ì‚°
   - í¬ìŠ¤íŠ¸ comments_count ì¦ê°€
   â†“
10. ëŒ“ê¸€ ID ë°˜í™˜
   â†“
11. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ëŒ“ê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸
```

### ì¢‹ì•„ìš” í† ê¸€ íë¦„

```
1. ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­
   â†“
2. v1_toggle_post_like ë˜ëŠ” v1_toggle_comment_like RPC í•¨ìˆ˜ í˜¸ì¶œ
   â†“
3. ì¸ì¦ í™•ì¸ (auth.uid())
   â†“
4. ì‚¬ìš©ì ID ì¡°íšŒ (tbl_users)
   â†“
5. í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
   â†“
6. ì¢‹ì•„ìš” ì¶”ê°€ ë˜ëŠ” ì œê±°
   â†“
7. íŠ¸ë¦¬ê±° ì‹¤í–‰:
   - likes_count ì¦ê°€ ë˜ëŠ” ê°ì†Œ
   â†“
8. ì—…ë°ì´íŠ¸ëœ ìƒíƒœ ë° ì¹´ìš´íŠ¸ ë°˜í™˜
   â†“
9. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ UI ì—…ë°ì´íŠ¸
```

---

## ê´€ë ¨ íŒŒì¼

### SQL íŒŒì¼

- `docs/sql/012_create_posts_table.sql` - í¬ìŠ¤íŠ¸ í…Œì´ë¸” ìƒì„±
- `docs/sql/013_create_comments_table.sql` - ëŒ“ê¸€ í…Œì´ë¸” ìƒì„±
- `docs/sql/014_create_interactions_tables.sql` - ì¸í„°ë™ì…˜ í…Œì´ë¸”ë“¤ ìƒì„±
- `docs/sql/015_v1_create_post.sql` - í¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
- `docs/sql/016_v1_fetch_feed.sql` - í”¼ë“œ ì¡°íšŒ í•¨ìˆ˜
- `docs/sql/017_v1_post_interactions.sql` - í¬ìŠ¤íŠ¸ ì¸í„°ë™ì…˜ í•¨ìˆ˜ë“¤
- `docs/sql/018_v1_comment_functions.sql` - ëŒ“ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤

### í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼

- `src/pages/feed/FeedPage.tsx` - í”¼ë“œ í˜ì´ì§€
- `src/pages/post-detail/PostDetailPage.tsx` - í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€
- `src/widgets/feed-timeline/FeedTimeline.tsx` - í”¼ë“œ íƒ€ì„ë¼ì¸ ìœ„ì ¯
- `src/entities/feed/` - í”¼ë“œ ì—”í‹°í‹°
- `src/entities/post/` - í¬ìŠ¤íŠ¸ ì—”í‹°í‹°
- `src/shared/ui/comment/CommentThread.tsx` - ëŒ“ê¸€ ìŠ¤ë ˆë“œ ì»´í¬ë„ŒíŠ¸

### íƒ€ì… ì •ì˜

- `src/entities/feed/model/feed.types.ts` - í”¼ë“œ íƒ€ì… ì •ì˜
- `src/entities/post/model/post.types.ts` - í¬ìŠ¤íŠ¸ íƒ€ì… ì •ì˜

---

## ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ìŠ¤ í™œìš©

- ì‘ì„±ìë³„ í¬ìŠ¤íŠ¸ ì¡°íšŒ: `idx_tbl_posts_author_id`
- íƒ€ì„ë¼ì¸ ì •ë ¬: `idx_tbl_posts_created_at`
- í”„ë¡œì íŠ¸ë³„ í¬ìŠ¤íŠ¸: `idx_tbl_posts_project_id`
- í¬ìŠ¤íŠ¸ë³„ ëŒ“ê¸€ ì¡°íšŒ: `idx_tbl_comments_post_id`
- ë¶€ëª¨ ëŒ“ê¸€ë³„ ë‹µê¸€ ì¡°íšŒ: `idx_tbl_comments_parent_id`

### ë¹„ì •ê·œí™”

- `likes_count`, `comments_count`, `bookmarks_count`ëŠ” ë¹„ì •ê·œí™”ë˜ì–´ ì €ì¥
- íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ë™ê¸°í™”
- ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ (JOIN ë¶ˆí•„ìš”)

### í˜ì´ì§€ë„¤ì´ì…˜

- `limit`ê³¼ `offset`ì„ ì‚¬ìš©í•œ í˜ì´ì§€ë„¤ì´ì…˜
- ê¸°ë³¸ `limit`: 50 (í¬ìŠ¤íŠ¸), 100 (ëŒ“ê¸€)
- ìµœëŒ€ `limit`: 100 (í¬ìŠ¤íŠ¸), 200 (ëŒ“ê¸€)

---

## í–¥í›„ í™•ì¥ ê°€ëŠ¥ ê¸°ëŠ¥

### í¬ìŠ¤íŠ¸ ê´€ë ¨
- í¬ìŠ¤íŠ¸ ìˆ˜ì • ê¸°ëŠ¥
- í¬ìŠ¤íŠ¸ ì‚­ì œ ê¸°ëŠ¥ (ì†Œí”„íŠ¸ ì‚­ì œ)
- í¬ìŠ¤íŠ¸ ê³µìœ  ê¸°ëŠ¥
- í¬ìŠ¤íŠ¸ ê³ ì • ê¸°ëŠ¥ (ì‘ì„±ì ì „ìš©)

### ëŒ“ê¸€ ê´€ë ¨
- ëŒ“ê¸€ ì‹ ê³  ê¸°ëŠ¥
- ëŒ“ê¸€ ê³ ì • ê¸°ëŠ¥ (ì‘ì„±ì ì „ìš©)
- ëŒ“ê¸€ ê²€ìƒ‰ ê¸°ëŠ¥

### ì¸í„°ë™ì…˜ ê´€ë ¨
- ì•Œë¦¼ ì‹œìŠ¤í…œ (ì¢‹ì•„ìš”, ëŒ“ê¸€, ë©˜ì…˜)
- ì½ìŒ ìƒíƒœ ê´€ë¦¬
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (WebSocket)

---

## ì°¸ê³ ì‚¬í•­

### ë°ì´í„° í˜•ì‹

- **ì´ë¯¸ì§€ ë°°ì—´**: JSONB ë°°ì—´ í˜•ì‹, ì˜ˆ: `["url1", "url2"]`
- **ë§í¬ í”„ë¦¬ë·°**: JSONB ê°ì²´ í˜•ì‹, ì˜ˆ: `{"url": "...", "title": "...", "description": "...", "image": "...", "domain": "..."}`
- **ë‚ ì§œ/ì‹œê°„**: ISO 8601 í˜•ì‹ (timestamptz)

### íŠ¸ë¦¬ê±° ë™ì‘

- ëª¨ë“  ì¹´ìš´íŠ¸(`likes_count`, `comments_count`, `bookmarks_count`)ëŠ” íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ìë™ ë™ê¸°í™”
- `updated_at`ì€ íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ìë™ ì—…ë°ì´íŠ¸
- ëŒ“ê¸€ `depth`ëŠ” íŠ¸ë¦¬ê±°ë¥¼ í†µí•´ ìë™ ê³„ì‚°

### ë©˜ì…˜ ì²˜ë¦¬

- ë©˜ì…˜ì€ `@username` í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ `tbl_mentions` í…Œì´ë¸”ì— ì €ì¥
- ì•Œë¦¼ ì‹œìŠ¤í…œê³¼ ì—°ë™ ê°€ëŠ¥ (í–¥í›„ êµ¬í˜„)

### ì†Œí”„íŠ¸ ì‚­ì œ

- í¬ìŠ¤íŠ¸ì™€ ëŒ“ê¸€ì€ ì†Œí”„íŠ¸ ì‚­ì œë¡œ ì²˜ë¦¬ (`is_deleted = true`)
- ì‚­ì œëœ í¬ìŠ¤íŠ¸ëŠ” í”¼ë“œì—ì„œ ì œì™¸
- ì‚­ì œëœ ëŒ“ê¸€ì€ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ í‘œì‹œë˜ì§€ë§Œ ë‚´ìš©ì€ ë§ˆìŠ¤í‚¹

