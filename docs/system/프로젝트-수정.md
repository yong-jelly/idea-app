# 프로젝트 수정 시스템

## 개요

사용자가 `/project/:id/edit` 페이지에서 자신이 작성한 프로젝트를 수정할 수 있는 기능입니다. 프로젝트 정보, 이미지, 링크 등을 수정하여 데이터베이스에 업데이트합니다.

## 주요 기능

### 1. 프로젝트 정보 수정

- **제목**: 프로젝트 이름 (필수)
- **짧은 설명**: 한 줄 요약 (필수, 최대 200자)
- **상세 설명**: 자세한 설명 (선택)
- **카테고리**: 프로젝트 분류 (필수, 단일 선택)
  - 게임, 웹, 모바일 앱, AI/ML, 개발 도구, 오픈소스 등
- **기술 스택**: 사용한 기술 태그 (선택, 최대 10개)
  - Enter 키로 추가/제거
  - 예: React, TypeScript, Node.js

### 2. 이미지 수정

- **썸네일**: 프로젝트 대표 이미지 (선택)
  - 기존 이미지 유지 또는 새 이미지 업로드
  - Storage 경로: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
- **갤러리 이미지**: 스크린샷 또는 기능 소개 이미지 (선택, 여러 개)
  - 기존 이미지 유지, 삭제, 또는 새 이미지 추가
  - Storage 경로: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`

### 3. 링크 수정 (선택)

- **저장소 URL**: GitHub 등 코드 저장소
- **데모 URL**: 웹 데모 사이트
- **앱스토어 링크**:
  - Google Play Store (Android)
  - App Store (iOS)
  - Mac App Store
- 링크 추가 섹션은 기본적으로 열려있음

## 접근 권한

- 프로젝트 작성자만 수정 가능
- 로그인한 사용자와 프로젝트 작성자가 동일한 경우에만 수정 버튼 표시
- 수정 페이지 접근 시 작성자 확인 (권한 없으면 에러 표시)

## 데이터베이스 스키마

### 테이블: `odd.projects`

프로젝트 등록 시스템과 동일한 테이블을 사용합니다. 자세한 내용은 [프로젝트 등록 시스템](./프로젝트-등록.md) 문서를 참고하세요.

**중요:**
- `updated_at` 컬럼은 트리거에 의해 자동으로 갱신됩니다
- 프로젝트 수정 시 `updated_at`이 현재 시간으로 자동 업데이트됩니다

## API 함수

### `updateProject`

프로젝트를 수정하는 함수입니다.

**위치**: `src/entities/project/api/project.api.ts`

**인터페이스**: `UpdateProjectData`

모든 필드명은 **snake_case**를 사용합니다 (데이터베이스 컬럼명과 일치).

```typescript
interface UpdateProjectData {
  title?: string;
  short_description?: string;        // snake_case, 선택
  full_description?: string;        // snake_case, 선택
  category?: ProjectCategory;        // 선택
  tech_stack?: string[];            // snake_case, JSON 배열로 저장, 선택
  thumbnail?: string;              // Storage 경로 또는 URL, 선택
  gallery_images?: string[];       // snake_case, Storage 경로 배열, 선택
  repository_url?: string;         // snake_case, 선택
  demo_url?: string;               // snake_case, 선택
  android_store_url?: string;      // snake_case, 선택
  ios_store_url?: string;          // snake_case, 선택
  mac_store_url?: string;          // snake_case, 선택
}
```

**중요 사항:**
- 모든 필드는 선택사항입니다 (undefined로 전달하면 해당 필드는 업데이트하지 않음)
- `author_id`는 수정할 수 없습니다 (프로젝트 작성자는 변경 불가)
- 통계 필드(`likes_count`, `comments_count` 등)는 수정할 수 없습니다

**사용 예시**:

```typescript
import { updateProject } from "@/entities/project";

const { success, error } = await updateProject(
  projectId,
  {
    title: "수정된 프로젝트 제목",
    short_description: "수정된 짧은 설명",
    full_description: "수정된 상세 설명",
    category: "web",
    tech_stack: ["Next.js", "TypeScript"],
    repository_url: "https://github.com/...",
    demo_url: "https://demo.example.com",
    // gallery_images: 기존 이미지 URL 배열 또는 새 이미지 경로 배열
  },
  thumbnailFile, // File | null, 새 썸네일 업로드 (선택)
  screenshotFiles // File[], 새 갤러리 이미지 업로드 (선택)
);

if (error) {
  console.error("프로젝트 수정 실패:", error.message);
} else {
  console.log("프로젝트 수정 성공");
  // 프로젝트 상세 페이지로 이동
  navigate(`/project/${projectId}`);
}
```

**필드명 변환**:

프론트엔드 폼에서는 camelCase를 사용하지만, API 호출 시 snake_case로 변환합니다:

| 프론트엔드 (camelCase) | API/DB (snake_case) |
|----------------------|-------------------|
| shortDescription | short_description |
| fullDescription | full_description |
| techStack | tech_stack |
| galleryImages | gallery_images |
| repositoryUrl | repository_url |
| demoUrl | demo_url |
| androidStoreUrl | android_store_url |
| iosStoreUrl | ios_store_url |
| macStoreUrl | mac_store_url |

**처리 흐름**:

1. **인증 확인**: 현재 로그인한 사용자의 `auth_id` 확인
2. **사용자 조회**: `auth_id`로 `tbl_users` 테이블에서 사용자 ID 조회
3. **프로젝트 소유자 확인**: 프로젝트의 `author_id`와 현재 사용자 ID 비교
4. **이미지 업로드**: 새로 업로드하는 이미지 파일이 있는 경우 업로드
   - 썸네일: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
   - 갤러리: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`
5. **프로젝트 업데이트**: 프로젝트 데이터를 데이터베이스에 업데이트
   - `updated_at`은 트리거에 의해 자동으로 갱신됨
6. **결과 반환**: 수정 성공 여부 또는 에러 반환

**에러 처리:**
- 인증 에러: 로그인이 필요하거나 세션이 만료된 경우
- 사용자 조회 에러: `tbl_users` 테이블에서 사용자를 찾을 수 없는 경우
- 권한 에러: 프로젝트 작성자가 아닌 경우
- 프로젝트 수정 에러: RLS 정책 위반 또는 데이터베이스 오류
- 이미지 업로드 에러: 업로드 실패 시 에러 반환

## SQL 함수

### `v1_update_project`

프로젝트를 수정하는 SQL 함수입니다.

**위치**: `docs/sql/027_v1_update_project.sql`

**실행 방법**:
```bash
psql "postgresql://postgres.xyqpggpilgcdsawuvpzn:ZNDqDunnaydr0aFQ@aws-0-ap-northeast-2.pooler.supabase.com:5432/postgres" -f docs/sql/027_v1_update_project.sql
```

**함수 시그니처**:
```sql
CREATE OR REPLACE FUNCTION odd.v1_update_project(
    p_project_id uuid,
    p_title text DEFAULT NULL,
    p_short_description text DEFAULT NULL,
    p_full_description text DEFAULT NULL,
    p_category text DEFAULT NULL,
    p_tech_stack jsonb DEFAULT NULL,
    p_thumbnail text DEFAULT NULL,
    p_gallery_images jsonb DEFAULT NULL,
    p_repository_url text DEFAULT NULL,
    p_demo_url text DEFAULT NULL,
    p_android_store_url text DEFAULT NULL,
    p_ios_store_url text DEFAULT NULL,
    p_mac_store_url text DEFAULT NULL
)
RETURNS odd.projects
```

**주요 기능**:
- 현재 로그인한 사용자가 프로젝트 작성자인지 확인
- 제공된 필드만 업데이트 (NULL인 필드는 업데이트하지 않음)
- `updated_at`은 트리거에 의해 자동으로 갱신됨
- 카테고리 유효성 검사

**보안**:
- `SECURITY DEFINER`: 함수 소유자 권한으로 실행
- `auth.uid()`로 현재 로그인한 사용자만 프로젝트 수정 가능
- 프로젝트 작성자만 수정 가능 (author_id 확인)
- RLS 정책과 함께 작동하여 보안 강화

## Storage 구조

### 이미지 경로

프로젝트 이미지는 `1dd-user-images` 버킷에 저장됩니다 (프로필 이미지와 동일한 버킷 사용).

- **썸네일**: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
  - 예: `550e8400-e29b-41d4-a716-446655440000/images/projects/123e4567-e89b-12d3-a456-426614174000/thumbnail-1704067200000.jpg`
- **갤러리 이미지**: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`
  - 예: `550e8400-e29b-41d4-a716-446655440000/images/projects/123e4567-e89b-12d3-a456-426614174000/screenshots/screenshot-1704067200000-0.jpg`

**참고:**
- `userId`는 `auth.uid()` (UUID 형식)
- `projectId`는 프로젝트의 `id` (UUID 형식)
- 파일 크기 제한: 5MB
- 지원 형식: JPEG, PNG, WebP, GIF

### Storage 함수

**위치**: `src/shared/lib/storage.ts`

- `uploadProjectThumbnail(file, userId, projectId)`: 썸네일 업로드
- `uploadProjectScreenshots(files, userId, projectId)`: 갤러리 이미지 업로드
- `getProjectImageUrl(filePath, transform?)`: 이미지 URL 가져오기

## 보안 (RLS 정책)

### 수정 권한

**프로젝트 수정 (UPDATE):**
- 작성자만 자신의 프로젝트를 수정할 수 있음
- 정책: `"Users can update own projects"` (UPDATE, TO authenticated)
- RLS 정책은 `odd.get_current_user_id()` 함수를 사용하여 사용자 ID를 조회
  - 이 함수는 `SECURITY DEFINER`로 실행되어 RLS를 우회하여 `tbl_users` 테이블에 접근

**RLS 정책 확인**:
```sql
-- 프로젝트 수정 정책
CREATE POLICY "Users can update own projects"
    ON odd.projects
    FOR UPDATE
    TO authenticated
    USING (
        author_id IN (
            SELECT id FROM odd.tbl_users WHERE auth_id = auth.uid()
        )
    )
    WITH CHECK (
        author_id IN (
            SELECT id FROM odd.tbl_users WHERE auth_id = auth.uid()
        )
    );
```

**참고:** RLS 정책 수정 SQL 파일: `docs/sql/009_fix_projects_rls_policy.sql`

## 카테고리 매핑

프론트엔드의 카테고리 ID를 데이터베이스의 ProjectCategory 타입으로 매핑합니다.

| UI 카테고리 ID | ProjectCategory |
|---------------|-----------------|
| game | game |
| web | web |
| mobile | mobile |
| ai | ai |
| devtool, utility, productivity, desktop | tool |
| opensource | opensource |
| social, education, entertainment, finance, music, news, shopping | web |
| health, lifestyle, travel | mobile |
| design | tool |

## 에러 처리

프로젝트 수정 시 발생할 수 있는 에러:

1. **인증 에러** (`"로그인이 필요합니다"`)
   - `supabase.auth.getUser()` 실패
   - 사용자가 로그인하지 않음

2. **사용자 조회 에러** (`"사용자 정보를 찾을 수 없습니다"`)
   - `tbl_users` 테이블에서 현재 사용자를 찾을 수 없음
   - 로그인은 했지만 DB에 사용자 정보가 없는 경우

3. **권한 에러** (`"프로젝트를 수정할 권한이 없습니다"`)
   - 프로젝트 작성자가 아닌 경우
   - 프로젝트를 찾을 수 없는 경우

4. **프로젝트 수정 에러** (`"프로젝트 수정에 실패했습니다"`)
   - RLS 정책 위반 (403 Forbidden)
   - 데이터베이스 제약조건 위반
   - 네트워크 오류
   - 상세한 에러 정보는 콘솔에 로깅됨

5. **이미지 업로드 에러**
   - 이미지 업로드 실패 시 에러 반환
   - 프로젝트는 수정되지 않음

**에러 로깅:**
- 모든 에러는 `console.error()`로 상세 정보와 함께 로깅됨
- 디버깅을 위한 인증 세션 정보도 로깅됨

**사용자 피드백:**
- 에러 발생 시 사용자에게 에러 메시지를 표시
- 프로젝트 수정에 실패한 경우 이전 페이지로 돌아가지 않고 폼을 유지
- 사용자가 입력한 데이터는 유지됨

## 성공 시 동작

프로젝트 수정 성공 시:

1. 수정된 프로젝트 정보가 데이터베이스에 저장됨
2. `updated_at`이 현재 시간으로 자동 갱신됨
3. `/project/{projectId}` 페이지로 리다이렉트
4. 사용자가 수정된 프로젝트를 확인할 수 있음

## UI/UX 특징

### 헤더
- 간단한 헤더 (등록 페이지와 달리 "둘러보기" 등 추가 기능 없음)
- 뒤로가기 버튼: 프로젝트 상세 페이지로 이동
- 제목: "프로젝트 수정"

### 링크 추가 섹션
- 기본적으로 열려있음 (등록 페이지와 달리 클릭할 필요 없음)
- 수정 시 링크 정보를 쉽게 확인하고 수정할 수 있음

### 제출 버튼
- 텍스트: "수정하기" (등록 페이지는 "등록하기")
- 로딩 중: "수정 중" 표시

## 관련 파일

- **페이지**: `src/pages/project/EditProjectPage.tsx`
- **헤더 컴포넌트**: `src/features/project-create/ui/EditProjectHeader.tsx`
- **API**: `src/entities/project/api/project.api.ts`
- **Storage**: `src/shared/lib/storage.ts`
- **타입**: `src/entities/project/model/project.types.ts`
- **SQL 함수**: 
  - `docs/sql/027_v1_update_project.sql` (프로젝트 수정 함수)
  - `docs/sql/007_create_projects_table.sql` (테이블 생성)
  - `docs/sql/009_fix_projects_rls_policy.sql` (RLS 정책 수정)

## 참고사항

### 인증 및 권한
- 프로젝트 수정은 `ProtectedRoute`로 보호되어 있어 로그인한 사용자만 접근 가능
- 프로젝트 작성자만 수정 가능 (프론트엔드 및 백엔드에서 모두 확인)
- RLS 정책은 `odd.get_current_user_id()` 함수를 사용하여 사용자 ID를 조회

### 이미지 업로드
- 이미지 업로드는 프로젝트 수정 전에 수행됨
- 프로젝트 수정 실패 시 이미지는 업로드되지 않음
- 기존 이미지는 URL로 유지되며, 새 이미지만 업로드됨
- 갤러리 이미지는 기존 이미지와 새 이미지를 함께 관리

### 데이터 형식
- 기술 스택(`tech_stack`)과 갤러리 이미지(`gallery_images`)는 JSONB 배열로 저장됨
- 빈 배열은 `[]`로 저장됨
- `author_id`는 수정할 수 없음 (프로젝트 작성자는 변경 불가)

### updated_at 자동 갱신
- `updated_at` 컬럼은 트리거(`trigger_projects_updated_at`)에 의해 자동으로 갱신됨
- 프로젝트 수정 시 `updated_at`이 현재 시간으로 자동 업데이트됨
- 함수나 API에서 명시적으로 `updated_at`을 설정할 필요 없음

### 디버깅
- 프로젝트 수정 시 인증 세션 정보가 콘솔에 로깅됨
- 에러 발생 시 상세한 에러 정보가 콘솔에 로깅됨
- 403 Forbidden 에러 발생 시 RLS 정책 및 스키마 권한 확인 필요

### 성능
- 프로젝트 수정 시 여러 인덱스가 사용되어 쿼리 성능 최적화
- GIN 인덱스를 사용하여 JSONB 필드 검색 성능 향상
- 부분 업데이트 지원 (변경된 필드만 업데이트)

