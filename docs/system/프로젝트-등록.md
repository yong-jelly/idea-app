# 프로젝트 등록 시스템

## 개요

사용자가 `/create-project` 페이지에서 프로젝트를 등록할 수 있는 기능입니다. 프로젝트 정보, 이미지, 링크 등을 입력하여 데이터베이스에 저장합니다.

## 주요 기능

### 1. 프로젝트 정보 입력

- **제목**: 프로젝트 이름 (필수)
- **짧은 설명**: 한 줄 요약 (필수, 최대 200자)
- **상세 설명**: 자세한 설명 (선택)
- **카테고리**: 프로젝트 분류 (필수, 단일 선택)
  - 게임, 웹, 모바일 앱, AI/ML, 개발 도구, 오픈소스 등
- **기술 스택**: 사용한 기술 태그 (선택, 최대 10개)
  - Enter 키로 추가
  - 예: React, TypeScript, Node.js

### 2. 이미지 업로드

- **썸네일**: 프로젝트 대표 이미지 (선택)
  - Storage 경로: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
- **갤러리 이미지**: 스크린샷 또는 기능 소개 이미지 (선택, 여러 개)
  - Storage 경로: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`

### 3. 링크 추가 (선택)

- **저장소 URL**: GitHub 등 코드 저장소
- **데모 URL**: 웹 데모 사이트
- **앱스토어 링크**:
  - Google Play Store (Android)
  - App Store (iOS)
  - Mac App Store

## 데이터베이스 스키마

### 테이블: `odd.projects`

```sql
CREATE TABLE odd.projects (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    title text NOT NULL,
    short_description text NOT NULL,
    full_description text,
    category text NOT NULL CHECK (category IN ('game', 'web', 'mobile', 'tool', 'opensource', 'ai')),
    tech_stack jsonb DEFAULT '[]'::jsonb,
    thumbnail text,
    gallery_images jsonb DEFAULT '[]'::jsonb,
    repository_url text,
    demo_url text,
    android_store_url text,
    ios_store_url text,
    mac_store_url text,
    author_id bigint NOT NULL REFERENCES odd.tbl_users(id) ON DELETE CASCADE,
    likes_count integer DEFAULT 0 NOT NULL,
    comments_count integer DEFAULT 0 NOT NULL,
    backers_count integer DEFAULT 0 NOT NULL,
    current_funding integer DEFAULT 0 NOT NULL,
    target_funding integer DEFAULT 0 NOT NULL,
    days_left integer DEFAULT 0 NOT NULL,
    status text DEFAULT 'funding' NOT NULL CHECK (status IN ('funding', 'in_progress', 'completed', 'cancelled')),
    featured boolean DEFAULT false NOT NULL,
    created_at timestamptz DEFAULT now() NOT NULL,
    updated_at timestamptz DEFAULT now() NOT NULL
);
```

**주요 인덱스:**
- `idx_projects_author_id`: 작성자 ID 인덱스
- `idx_projects_category`: 카테고리 인덱스
- `idx_projects_status`: 상태 인덱스
- `idx_projects_featured`: 추천 프로젝트 인덱스 (WHERE featured = true)
- `idx_projects_created_at`: 생성일시 인덱스 (DESC)
- `idx_projects_likes_count`: 좋아요 수 인덱스 (DESC)
- `idx_projects_tech_stack`: 기술 스택 GIN 인덱스 (JSON 검색용)
- `idx_projects_gallery_images`: 갤러리 이미지 GIN 인덱스 (JSON 검색용)

### 주요 컬럼 설명

- `id`: 프로젝트 고유 ID (UUID, 자동 생성)
- `author_id`: 작성자 ID (bigint, `odd.tbl_users.id` 참조)
  - **중요**: API에서 자동으로 현재 로그인한 사용자의 ID를 조회하여 설정
  - 프론트엔드에서 직접 전달하지 않음
- `category`: 프로젝트 카테고리 (CHECK 제약조건)
  - 허용 값: `game`, `web`, `mobile`, `tool`, `opensource`, `ai`
- `tech_stack`: 기술 스택 배열 (JSONB)
  - 예: `["React", "TypeScript", "Node.js"]`
  - 빈 배열: `[]`
- `gallery_images`: 갤러리 이미지 경로 배열 (JSONB)
  - 예: `["path/to/image1.jpg", "path/to/image2.jpg"]`
  - 빈 배열: `[]`
- `status`: 프로젝트 상태 (CHECK 제약조건)
  - `funding`: 펀딩 중 (기본값)
  - `in_progress`: 진행 중
  - `completed`: 완료
  - `cancelled`: 취소됨
- `updated_at`: 자동 업데이트 트리거로 수정 시 자동 갱신

## API 함수

### `createProject`

프로젝트를 생성하는 함수입니다.

**위치**: `src/entities/project/api/project.api.ts`

**인터페이스**: `CreateProjectData`

모든 필드명은 **snake_case**를 사용합니다 (데이터베이스 컬럼명과 일치).

```typescript
interface CreateProjectData {
  title: string;
  short_description: string;        // snake_case, 필수
  full_description?: string;        // snake_case, 선택
  category: ProjectCategory;        // 필수
  tech_stack: string[];            // snake_case, JSON 배열로 저장
  thumbnail?: string;              // Storage 경로 또는 URL, 선택
  gallery_images?: string[];       // snake_case, Storage 경로 배열, 선택
  repository_url?: string;         // snake_case, 선택
  demo_url?: string;               // snake_case, 선택
  android_store_url?: string;      // snake_case, 선택
  ios_store_url?: string;          // snake_case, 선택
  mac_store_url?: string;          // snake_case, 선택
  author_id?: number;              // snake_case, 선택 (API에서 자동 조회)
}
```

**중요 사항:**
- `author_id`는 선택사항이며, API 내부에서 현재 로그인한 사용자의 `auth_id`로 `tbl_users` 테이블에서 조회하여 자동 설정됩니다.
- 프론트엔드에서는 `author_id`를 전달하지 않아도 됩니다.

**사용 예시**:

```typescript
import { createProject } from "@/entities/project";

const { projectId, error } = await createProject(
  {
    title: "AI 코드 리뷰 도구",
    short_description: "머신러닝을 활용한 자동 코드 리뷰 도구",
    full_description: "상세 설명...",
    category: "ai",
    tech_stack: ["Python", "TensorFlow", "React"],
    repository_url: "https://github.com/...",
    demo_url: "https://demo.example.com",
    // author_id는 전달하지 않음 (API에서 자동 조회)
  },
  thumbnailFile, // File | null, 선택
  screenshotFiles // File[], 선택
);

if (error) {
  console.error("프로젝트 생성 실패:", error.message);
} else {
  console.log("프로젝트 생성 성공:", projectId);
  // 프로젝트 상세 페이지로 이동
  navigate(`/project/${projectId}`);
}
```

**필드명 변환**:

프론트엔드 폼에서는 camelCase를 사용하지만, API 호출 시 snake_case로 변환합니다:

| 프론트엔드 (camelCase) | API/DB (snake_case) |
|----------------------|-------------------|
| shortDescription | short_description |
| fullDescription | full_description |
| techStack | tech_stack |
| galleryImages | gallery_images |
| repositoryUrl | repository_url |
| demoUrl | demo_url |
| androidStoreUrl | android_store_url |
| iosStoreUrl | ios_store_url |
| macStoreUrl | mac_store_url |
| authorId | author_id |

**처리 흐름**:

1. **인증 확인**: 현재 로그인한 사용자의 `auth_id` 확인
2. **사용자 조회**: `auth_id`로 `tbl_users` 테이블에서 사용자 ID 조회
3. **세션 확인**: 인증 세션이 유효한지 확인 (디버깅 및 보안)
4. **프로젝트 생성**: 프로젝트 데이터를 데이터베이스에 삽입
5. **이미지 업로드**: 프로젝트 ID 생성 후 이미지 파일 업로드
   - 썸네일: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
   - 갤러리: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`
6. **이미지 경로 업데이트**: 업로드된 이미지 경로를 프로젝트에 업데이트
7. **결과 반환**: 생성된 프로젝트 ID 또는 에러 반환

**에러 처리:**
- 인증 에러: 로그인이 필요하거나 세션이 만료된 경우
- 사용자 조회 에러: `tbl_users` 테이블에서 사용자를 찾을 수 없는 경우
- 프로젝트 생성 에러: RLS 정책 위반 또는 데이터베이스 오류
- 이미지 업로드 에러: 업로드 실패 시에도 프로젝트는 생성되며 경고만 표시

## Storage 구조

### 이미지 경로

프로젝트 이미지는 `1dd-user-images` 버킷에 저장됩니다 (프로필 이미지와 동일한 버킷 사용).

- **썸네일**: `{userId}/images/projects/{projectId}/thumbnail-{timestamp}.{ext}`
  - 예: `550e8400-e29b-41d4-a716-446655440000/images/projects/123e4567-e89b-12d3-a456-426614174000/thumbnail-1704067200000.jpg`
- **갤러리 이미지**: `{userId}/images/projects/{projectId}/screenshots/screenshot-{timestamp}-{index}.{ext}`
  - 예: `550e8400-e29b-41d4-a716-446655440000/images/projects/123e4567-e89b-12d3-a456-426614174000/screenshots/screenshot-1704067200000-0.jpg`

**참고:**
- `userId`는 `auth.uid()` (UUID 형식)
- `projectId`는 프로젝트의 `id` (UUID 형식)
- 파일 크기 제한: 5MB
- 지원 형식: JPEG, PNG, WebP, GIF

### Storage 함수

**위치**: `src/shared/lib/storage.ts`

- `uploadProjectThumbnail(file, userId, projectId)`: 썸네일 업로드
- `uploadProjectScreenshots(files, userId, projectId)`: 갤러리 이미지 업로드
- `getProjectImageUrl(filePath, transform?)`: 이미지 URL 가져오기

## 보안 (RLS 정책)

### 읽기 권한
- 모든 사용자(공개)가 프로젝트를 읽을 수 있음
- 정책: `"Anyone can read projects"` (SELECT, TO public, USING (true))

### 쓰기 권한

**프로젝트 생성 (INSERT):**
- 인증된 사용자만 프로젝트를 생성할 수 있음
- `author_id`가 현재 로그인한 사용자의 `tbl_users.id`와 일치해야 함
- 정책: `"Authenticated users can create projects"` (INSERT, TO authenticated)
- RLS 정책은 `odd.get_current_user_id()` 함수를 사용하여 사용자 ID를 조회
  - 이 함수는 `SECURITY DEFINER`로 실행되어 RLS를 우회하여 `tbl_users` 테이블에 접근

**프로젝트 수정 (UPDATE):**
- 작성자만 자신의 프로젝트를 수정할 수 있음
- 정책: `"Users can update own projects"` (UPDATE, TO authenticated)

**프로젝트 삭제 (DELETE):**
- 작성자만 자신의 프로젝트를 삭제할 수 있음
- 정책: `"Users can delete own projects"` (DELETE, TO authenticated)

### RLS 헬퍼 함수

`odd.get_current_user_id()` 함수:
- 현재 로그인한 사용자의 `tbl_users.id`를 반환
- `SECURITY DEFINER`로 실행되어 RLS 정책을 우회
- `auth.uid()`가 NULL이면 NULL 반환
- `tbl_users` 테이블의 RLS 정책 때문에 직접 서브쿼리 대신 함수 사용

### 스키마 권한

`odd` 스키마에 대한 권한:
```sql
GRANT ALL ON SCHEMA odd TO authenticated, anon;
GRANT ALL ON ALL TABLES IN SCHEMA odd TO authenticated, anon;
GRANT ALL ON ALL SEQUENCES IN SCHEMA odd TO authenticated, anon;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA odd TO authenticated, anon;
```

**참고:** RLS 정책 수정 SQL 파일: `docs/sql/009_fix_projects_rls_policy.sql`

## 카테고리 매핑

프론트엔드의 카테고리 ID를 데이터베이스의 ProjectCategory 타입으로 매핑합니다.

| UI 카테고리 ID | ProjectCategory |
|---------------|-----------------|
| game | game |
| web | web |
| mobile | mobile |
| ai | ai |
| devtool, utility, productivity, desktop | tool |
| opensource | opensource |
| social, education, entertainment, finance, music, news, shopping | web |
| health, lifestyle, travel | mobile |
| design | tool |

## 에러 처리

프로젝트 생성 시 발생할 수 있는 에러:

1. **인증 에러** (`"로그인이 필요합니다"`)
   - `supabase.auth.getUser()` 실패
   - 사용자가 로그인하지 않음

2. **세션 에러** (`"인증 세션이 없습니다. 다시 로그인해주세요."`)
   - `supabase.auth.getSession()` 실패
   - 세션이 만료되었거나 유효하지 않음

3. **사용자 조회 에러** (`"사용자 정보를 찾을 수 없습니다"`)
   - `tbl_users` 테이블에서 현재 사용자를 찾을 수 없음
   - 로그인은 했지만 DB에 사용자 정보가 없는 경우

4. **프로젝트 생성 에러** (`"프로젝트 생성에 실패했습니다"`)
   - RLS 정책 위반 (403 Forbidden)
   - 데이터베이스 제약조건 위반
   - 네트워크 오류
   - 상세한 에러 정보는 콘솔에 로깅됨:
     - 에러 코드 (`code`)
     - 에러 메시지 (`message`)
     - 상세 정보 (`details`)
     - 힌트 (`hint`)
     - 프로젝트 데이터 및 사용자 ID

5. **이미지 업로드 에러**
   - 이미지 업로드 실패 시에도 프로젝트는 생성됨
   - 콘솔에 경고 메시지 표시
   - 프로젝트는 이미지 없이 생성됨

**에러 로깅:**
- 모든 에러는 `console.error()`로 상세 정보와 함께 로깅됨
- 디버깅을 위한 인증 세션 정보도 로깅됨

**사용자 피드백:**
- 에러 발생 시 사용자에게 에러 메시지를 표시
- 프로젝트 생성에 실패한 경우 이전 페이지로 돌아가지 않고 폼을 유지
- 사용자가 입력한 데이터는 유지됨

## 성공 시 동작

프로젝트 생성 성공 시:

1. 생성된 프로젝트 ID를 받아옴
2. `/project/{projectId}` 페이지로 리다이렉트
3. 사용자가 생성된 프로젝트를 확인할 수 있음

## 관련 파일

- **페이지**: `src/pages/project/CreateProjectPage.tsx`
- **API**: `src/entities/project/api/project.api.ts`
- **Storage**: `src/shared/lib/storage.ts`
- **타입**: `src/entities/project/model/project.types.ts`
- **SQL 스키마**: 
  - `docs/sql/007_create_projects_table.sql` (테이블 생성)
  - `docs/sql/009_fix_projects_rls_policy.sql` (RLS 정책 수정)

## 참고사항

### 인증 및 권한
- 프로젝트 생성은 `ProtectedRoute`로 보호되어 있어 로그인한 사용자만 접근 가능
- `author_id`는 API에서 자동으로 설정되므로 프론트엔드에서 전달할 필요 없음
- RLS 정책은 `odd.get_current_user_id()` 함수를 사용하여 사용자 ID를 조회

### 이미지 업로드
- 이미지 업로드는 프로젝트 생성 후에 수행됨
- 프로젝트 생성 실패 시 이미지는 업로드되지 않음
- 이미지 업로드 실패 시에도 프로젝트는 생성되며, 콘솔에 경고만 표시됨
- 이미지 경로는 프로젝트 생성 후 업데이트됨

### 데이터 형식
- 기술 스택(`tech_stack`)과 갤러리 이미지(`gallery_images`)는 JSONB 배열로 저장됨
- 빈 배열은 `[]`로 저장됨
- `author_id`는 `bigint` 타입 (UUID가 아님)

### 디버깅
- 프로젝트 생성 시 인증 세션 정보가 콘솔에 로깅됨
- 에러 발생 시 상세한 에러 정보가 콘솔에 로깅됨
- 403 Forbidden 에러 발생 시 RLS 정책 및 스키마 권한 확인 필요

### 성능
- 프로젝트 생성 시 여러 인덱스가 사용되어 쿼리 성능 최적화
- GIN 인덱스를 사용하여 JSONB 필드 검색 성능 향상

