# 커뮤니티 마일스톤 시스템

## 개요

프로젝트 커뮤니티에서 프로젝트의 주요 목표와 마일스톤을 관리하는 시스템입니다. 프로젝트 생성자만 마일스톤을 생성/수정/삭제할 수 있으며, 일반 사용자는 조회만 가능합니다.

### 주요 기능

- **마일스톤 작성/수정/삭제**: 프로젝트의 주요 목표 관리
- **상태 관리**: 진행 중(open) / 완료(closed) 상태 전환
- **기한 설정**: 목표 기한 설정 및 D-day 표시
- **진행률 표시**: 완료된 이슈 수와 남은 이슈 수를 기반으로 진행률 계산
- **필터링**: 전체/진행 중/완료 상태별 필터링
- **정렬**: 진행 중 마일스톤 우선, 그 다음 최신순 정렬

---

## 데이터베이스 스키마

### 마일스톤 테이블 (`odd.tbl_milestones`)

프로젝트의 마일스톤을 저장하는 테이블입니다. `odd.projects`와 N:1 관계입니다.

#### 스키마

```sql
CREATE TABLE odd.tbl_milestones (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id uuid NOT NULL REFERENCES odd.projects(id) ON DELETE CASCADE,
    
    -- 마일스톤 정보
    title text NOT NULL,  -- 제목 (최대 50자)
    description text,  -- 설명 (최대 200자)
    due_date date,  -- 목표 기한
    
    -- 상태
    status text NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'closed')),  -- 상태
    
    -- 통계 (비정규화)
    open_issues_count integer DEFAULT 0 NOT NULL,  -- 진행 중인 이슈 수
    closed_issues_count integer DEFAULT 0 NOT NULL,  -- 완료된 이슈 수
    
    -- 타임스탬프
    created_at timestamptz DEFAULT now() NOT NULL,
    updated_at timestamptz DEFAULT now() NOT NULL,
    closed_at timestamptz  -- 완료일시 (status가 'closed'일 때 설정)
);
```

#### 주요 컬럼 설명

| 컬럼 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `id` | uuid | ✅ | 고유 ID (자동 생성) |
| `project_id` | uuid | ✅ | 프로젝트 ID (`odd.projects.id` 참조) |
| `title` | text | ✅ | 제목 (최대 50자) |
| `description` | text | - | 설명 (최대 200자) |
| `due_date` | date | - | 목표 기한 |
| `status` | text | ✅ | 상태: `open`, `closed` (기본값: `open`) |
| `open_issues_count` | integer | ✅ | 진행 중인 이슈 수 (기본값: 0) |
| `closed_issues_count` | integer | ✅ | 완료된 이슈 수 (기본값: 0) |
| `created_at` | timestamptz | ✅ | 생성일시 |
| `updated_at` | timestamptz | ✅ | 수정일시 (트리거로 자동 업데이트) |
| `closed_at` | timestamptz | - | 완료일시 (status가 'closed'일 때 설정) |

#### 인덱스

| 인덱스명 | 컬럼 | 용도 |
|---------|------|------|
| `idx_tbl_milestones_project_id` | `project_id` | 프로젝트별 마일스톤 조회 |
| `idx_tbl_milestones_status` | `status` | 상태별 조회 |
| `idx_tbl_milestones_created_at` | `created_at DESC` | 최신순 정렬 |

---

## API 함수 명세

### 1. 마일스톤 목록 조회 (`v1_fetch_milestones`)

프로젝트의 마일스톤 목록을 조회합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_fetch_milestones(
    p_project_id uuid,
    p_status text DEFAULT NULL,  -- 'all', 'open', 'closed' (NULL이면 'all')
    p_limit integer DEFAULT 30,
    p_offset integer DEFAULT 0
)
RETURNS TABLE (
    id uuid,
    project_id uuid,
    title text,
    description text,
    due_date date,
    status text,
    open_issues_count integer,
    closed_issues_count integer,
    created_at timestamptz,
    updated_at timestamptz,
    closed_at timestamptz
)
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_project_id` | uuid | ✅ | 프로젝트 ID |
| `p_status` | text | - | 상태 필터: `'all'`, `'open'`, `'closed'` (NULL이면 전체) |
| `p_limit` | integer | - | 조회 개수 제한 (기본값: 30, 최대: 100) |
| `p_offset` | integer | - | 페이지네이션 오프셋 (기본값: 0) |

#### 반환값

마일스톤 목록 (정렬: 진행 중 우선, 그 다음 최신순)

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_fetch_milestones", {
    p_project_id: projectId,
    p_status: "open", // 또는 "closed", "all", null
    p_limit: 30,
    p_offset: 0,
  });
```

---

### 2. 마일스톤 생성 (`v1_create_milestone`)

새 마일스톤을 생성합니다. 프로젝트 생성자만 생성 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_create_milestone(
    p_project_id uuid,
    p_title text,
    p_description text DEFAULT NULL,
    p_due_date date DEFAULT NULL
)
RETURNS uuid
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_project_id` | uuid | ✅ | 프로젝트 ID |
| `p_title` | text | ✅ | 제목 (최대 50자) |
| `p_description` | text | - | 설명 (최대 200자) |
| `p_due_date` | date | - | 목표 기한 |

#### 반환값

생성된 마일스톤 ID (uuid)

#### 권한

- 프로젝트 생성자만 생성 가능
- 인증된 사용자만 호출 가능

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_create_milestone", {
    p_project_id: projectId,
    p_title: "v2.0 출시",
    p_description: "핵심 기능을 포함한 최소 기능 제품 출시",
    p_due_date: "2024-10-01", // YYYY-MM-DD 형식
  });
```

---

### 3. 마일스톤 수정 (`v1_update_milestone`)

마일스톤을 수정합니다. 프로젝트 생성자만 수정 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_update_milestone(
    p_milestone_id uuid,
    p_title text DEFAULT NULL,
    p_description text DEFAULT NULL,
    p_due_date date DEFAULT NULL
)
RETURNS boolean
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_milestone_id` | uuid | ✅ | 마일스톤 ID |
| `p_title` | text | - | 제목 (NULL이면 변경하지 않음) |
| `p_description` | text | - | 설명 (NULL이면 변경하지 않음) |
| `p_due_date` | date | - | 목표 기한 (NULL이면 변경하지 않음) |

#### 반환값

성공 여부 (boolean)

#### 권한

- 프로젝트 생성자만 수정 가능
- 인증된 사용자만 호출 가능

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_update_milestone", {
    p_milestone_id: milestoneId,
    p_title: "수정된 제목",
    p_description: "수정된 설명",
    p_due_date: "2024-11-01",
  });
```

---

### 4. 마일스톤 삭제 (`v1_delete_milestone`)

마일스톤을 삭제합니다. 프로젝트 생성자만 삭제 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_delete_milestone(
    p_milestone_id uuid
)
RETURNS boolean
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_milestone_id` | uuid | ✅ | 마일스톤 ID |

#### 반환값

성공 여부 (boolean)

#### 권한

- 프로젝트 생성자만 삭제 가능
- 인증된 사용자만 호출 가능

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_delete_milestone", {
    p_milestone_id: milestoneId,
  });
```

---

### 5. 마일스톤 상태 토글 (`v1_toggle_milestone_status`)

마일스톤의 상태를 토글합니다 (open ↔ closed). 프로젝트 생성자만 가능합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_toggle_milestone_status(
    p_milestone_id uuid
)
RETURNS boolean
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_milestone_id` | uuid | ✅ | 마일스톤 ID |

#### 반환값

성공 여부 (boolean)

#### 동작

- `open` → `closed`: `closed_at`을 현재 시간으로 설정
- `closed` → `open`: `closed_at`을 NULL로 설정

#### 권한

- 프로젝트 생성자만 토글 가능
- 인증된 사용자만 호출 가능

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_toggle_milestone_status", {
    p_milestone_id: milestoneId,
  });
```

---

### 6. 마일스톤 상세 조회 (`v1_fetch_milestone_detail`)

특정 마일스톤의 상세 정보를 조회합니다.

#### 함수 시그니처

```sql
CREATE OR REPLACE FUNCTION odd.v1_fetch_milestone_detail(
    p_milestone_id uuid
)
RETURNS TABLE (
    id uuid,
    project_id uuid,
    title text,
    description text,
    due_date date,
    status text,
    open_issues_count integer,
    closed_issues_count integer,
    created_at timestamptz,
    updated_at timestamptz,
    closed_at timestamptz
)
```

#### 매개변수

| 매개변수 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `p_milestone_id` | uuid | ✅ | 마일스톤 ID |

#### 반환값

마일스톤 상세 정보 (단일 행)

#### 사용 예시

```typescript
const { data, error } = await supabase
  .schema("odd")
  .rpc("v1_fetch_milestone_detail", {
    p_milestone_id: milestoneId,
  });
```

---

## 권한 정책

### RLS (Row Level Security) 정책

#### 읽기 (SELECT)

- **정책명**: `Anyone can read milestones`
- **권한**: 모든 사용자 (공개)
- **설명**: 인증 여부와 관계없이 모든 사용자가 마일스톤을 조회할 수 있습니다.

#### 생성 (INSERT)

- **정책명**: `Project owners can create milestones`
- **권한**: 프로젝트 생성자만
- **설명**: 프로젝트 생성자만 마일스톤을 생성할 수 있습니다. 권한 체크는 함수 내에서 수행됩니다.

#### 수정 (UPDATE)

- **정책명**: `Project owners can update milestones`
- **권한**: 프로젝트 생성자만
- **설명**: 프로젝트 생성자만 마일스톤을 수정할 수 있습니다. 권한 체크는 함수 내에서 수행됩니다.

#### 삭제 (DELETE)

- **정책명**: `Project owners can delete milestones`
- **권한**: 프로젝트 생성자만
- **설명**: 프로젝트 생성자만 마일스톤을 삭제할 수 있습니다. 권한 체크는 함수 내에서 수행됩니다.

---

## 프론트엔드 연동

### API 함수 위치

`src/entities/project/api/project.api.ts`

### 주요 함수

- `fetchMilestones(projectId, options)`: 마일스톤 목록 조회
- `fetchMilestoneDetail(milestoneId)`: 마일스톤 상세 조회
- `createMilestone(projectId, data)`: 마일스톤 생성
- `updateMilestone(milestoneId, data)`: 마일스톤 수정
- `deleteMilestone(milestoneId)`: 마일스톤 삭제
- `toggleMilestoneStatus(milestoneId)`: 마일스톤 상태 토글

### 컴포넌트

- `src/pages/project/community/tabs/MilestonesTab.tsx`: 마일스톤 탭 컴포넌트
- `src/pages/project/MilestoneDetailPage.tsx`: 마일스톤 상세 페이지 컴포넌트

---

## 데이터 흐름

```
사용자 액션
  ↓
MilestonesTab 컴포넌트
  ↓
project.api.ts 함수 호출
  ↓
Supabase RPC 함수 호출
  ↓
PostgreSQL 함수 실행
  ↓
RLS 정책 검사
  ↓
데이터베이스 조작
  ↓
결과 반환
```

---

## 참고사항

1. **이슈 카운트**: 현재는 `open_issues_count`와 `closed_issues_count`만 관리하며, 실제 이슈/태스크 기능은 별도로 구현 예정입니다.

2. **진행률 계산**: 프론트엔드에서 `closed_issues_count / (open_issues_count + closed_issues_count) * 100`로 계산합니다.

3. **기한 표시**: 프론트엔드에서 D-day 계산 및 지연 여부 표시를 수행합니다.

4. **정렬 규칙**: 
   - 진행 중(`open`) 마일스톤이 완료(`closed`) 마일스톤보다 먼저 표시
   - 같은 상태 내에서는 최신순(`updated_at DESC`) 정렬

5. **상세 페이지**: 마일스톤 상세 페이지(`/project/:id/community/milestones/:milestoneId`)에서 마일스톤의 상세 정보를 확인할 수 있습니다. 현재는 tasks 기능이 하드코딩 상태이며, 별도로 구현 예정입니다.

